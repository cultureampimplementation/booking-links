<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book your session</title>
  <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

      :root{
          color-scheme: light dark;

          /* Light Mode Colors */
          --purple: #7c3aed;
          --purple-light: #ede9fe;
          --bg-primary: #f9fafb;
          --bg-secondary: #ffffff;
          --text-primary: #1f2937;
          --text-secondary: #6b7280;
          --border-color: #e5e7eb;
          --rail: #d1d5db;

          /* Shadows */
          --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
          --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);

          /* timeline geometry */
          --dot-size: 18px;
          --dot-col: 28px;
          --left-gutter: 62px;
          --rail-w: 4px;
          --dot-ring: var(--rail-w);
          --tl-pad-y: 12px;
          --step-pad-y: 12px;
          --dot-outer: calc(var(--dot-size) + 2 * var(--dot-ring));

          /* month pills */
          --pill-w: 300px;
          --week-pill-gap: 12px;
          --agenda-width: 550px;
      }

      /* Dark Mode Overrides */
      @media (prefers-color-scheme: dark) {
          :root {
              --purple-light: #4c1d95;
              --bg-primary: #111827;
              --bg-secondary: #1f2937;
              --text-primary: #f9fafb;
              --text-secondary: #9ca3af;
              --border-color: #374151;
              --rail: #4b5563;
          }
      }

      html, body {
          margin:0;
          padding:0;
          font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
          background-color: var(--bg-primary);
          color: var(--text-primary);
      }
      body { padding: 32px; }

      /* Header */
      .h-wrap { margin-bottom: 10px; }
      .h-eyebrow { font-size: 13px; color: var(--text-secondary); }
      .h-title { font-weight: 800; font-size: clamp(20px, 3.3vw, 36px); line-height: 1.15; margin-top: 4px; }

      /* Notice */
      .notice { margin-top:10px; color: var(--text-secondary); font-size:14px; }

      /* Timeline (single row items; rail behind dots) */
      .timeline{
          position: relative;
          padding: var(--tl-pad-y) 14px var(--tl-pad-y) var(--left-gutter);
          margin-top: 16px;
      }
      .timeline::before{
          content: "";
          position: absolute;
          top: calc(var(--tl-pad-y) + var(--step-pad-y) + (var(--dot-outer) / 2));
          bottom: calc(var(--tl-pad-y) + var(--step-pad-y) + (var(--dot-outer) / 2));
          left: calc(var(--left-gutter) + (var(--dot-col) / 2) - (var(--rail-w) / 2));
          width: var(--rail-w);
          background: var(--rail);
          border-radius: 4px;
          z-index: 0;
      }

      #timeline{ display: grid; gap: 0; }

      .t-step{
          display: grid;
          grid-template-columns: var(--dot-col) 1fr;
          align-items: center;
          gap: 14px;
          padding: var(--step-pad-y) 0;
      }

      .t-dot{
          justify-self: center;
          align-self: center;
          width: var(--dot-size);
          height: var(--dot-size);
          border-radius: 999px;
          border: var(--dot-ring) solid var(--rail);
          background: var(--bg-secondary);
          position: relative;
          z-index: 1;
      }

      /* states */
      .t-dot.active{
          background: var(--purple);
          border-color: var(--purple);
          box-shadow: 0 0 0 4px color-mix(in srgb, var(--purple) 20%, transparent);
      }

      .t-dot.done{
          background: var(--purple);
          border-color: var(--purple);
      }
      .t-dot.done::after{
          content: "";
          position: absolute;
          top: 50%;
          left: 50%;
          width: calc(var(--dot-size) * .55);
          height: calc(var(--dot-size) * .33);
          border-left: 3px solid #fff;
          border-bottom: 3px solid #fff;
          transform: translate(-50%, -55%) rotate(-45deg);
          border-radius: 1px;
      }

      /* body = title | ctas on one row; inline content spans full width below */
      .t-body{
          display: grid;
          grid-template-columns: auto auto 1fr;
          align-items: baseline;
          column-gap: 10px;
          padding: 6px 0;
      }
      .t-title{
          font-weight: 700;
          font-size: 20px;
          line-height: 1.2;
      }
      .t-cta{ justify-self: start; display: inline-flex; gap: 8px; flex-wrap: nowrap; }
      .t-sub{ display:none !important; }

      .t-body .agenda-wrap,
      .t-body #s3Mount{
          grid-column: 1 / -1;
          margin-top: 10px;
      }

      .btn {
          padding: 10px 16px;
          border: 1px solid transparent;
          background: var(--purple);
          color: #fff;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          font-family: inherit;
          transition: all 0.2s ease-in-out;
      }
      .btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: var(--shadow-md);
      }
      .btn.secondary { background:var(--bg-secondary); color:var(--purple); border-color: var(--border-color); }
      .btn:disabled { opacity:.6; cursor:default; }
      .link { background:none; border:none; padding:0; color:var(--purple); text-decoration:underline; cursor:pointer; font-family: inherit; }
      .muted { color: var(--text-secondary); }

      /* Cards */
      .card {
          border:1px solid var(--border-color);
          border-radius:12px;
          background: var(--bg-secondary);
          padding: 20px;
          box-shadow: var(--shadow-sm);
      }

      #landingInline { margin-top: 0; }
      .ov-grid{
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(calc(var(--pill-w) + 24px), max-content));
          gap: 14px;
      }

      .mcard{
          border:1px solid var(--border-color);
          border-radius:12px;
          background: var(--bg-secondary);
          padding:12px;
          width: fit-content;
          min-width: calc(var(--pill-w) + 24px);
      }
      .mhead{ display:flex; align-items:baseline; justify-content:space-between; gap:8px; margin-bottom:8px; }
      .mname{ font-weight:900; font-size:18px; }

      .mcard .mhead + div{ display:grid; gap: var(--week-pill-gap); }

      .week-pill{
          background: var(--purple-light);
          color: var(--text-primary);
          border:1px solid var(--border-color);
          border-radius:10px;
          padding:10px 12px;
          font-weight:800;
          font-size:14px;
          text-align:left;
          cursor:pointer;
          display:block;
          width: var(--pill-w);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .week-pill:hover:not(.disabled) {
          transform: translateY(-2px);
          box-shadow: var(--shadow-sm);
      }

      .week-pill.disabled{
          background: color-mix(in srgb, var(--bg-secondary) 50%, var(--bg-primary));
          color: var(--text-secondary);
          border-color: var(--border-color);
          cursor:default;
      }

      /* Week grid */
      .week-wrap{ border:1px solid var(--border-color); border-radius:12px; background: var(--bg-secondary); padding:14px; }
      .week-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .week-title{ font-weight:900; font-size:20px; }
      .week-list{ display: grid; gap: 10px; }
      .nav-btn{ padding:6px 10px; border:1px solid var(--border-color); background: var(--bg-secondary); border-radius:8px; cursor:pointer; }
      .grid{ border:1px solid var(--border-color); border-radius:12px; overflow:hidden; margin-top:10px; }
      .grid-header{ display:grid; grid-template-columns:repeat(7,1fr); }
      .grid-header div{ text-align:center; font-size:12px; padding:6px 0; background: var(--bg-primary); border-bottom:1px solid var(--border-color); font-weight:800; }
      .days{ display:grid; grid-template-columns:repeat(7,1fr); }
      .day{ border-right:1px solid var(--border-color); border-bottom:1px solid var(--border-color); min-height:120px; padding:6px; }
      .day:nth-child(7n){ border-right:none; }
      .date{ font-size:12px; font-weight:700; color: var(--text-primary); }
      .day.past .date{ color: var(--text-secondary); }
      .day-body{ display:grid; gap:8px; }
      .pill{ border:1px solid var(--border-color); background: var(--bg-primary); border-radius:10px; padding:8px 10px; min-height:30px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:13px; justify-content:center; }
      .pill .icon{ width:1.1em; text-align:center; opacity:.55; }
      .pill.selected{ background:var(--purple); color:#fff; border-color:var(--purple); }

      /* Prep modal */
      .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
      .modal{ width:min(720px, 92vw); background: var(--bg-secondary); border-radius:12px; box-shadow:var(--shadow-md); overflow:hidden; }
      .modal header, .modal footer{ padding:12px 16px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .modal footer{ border-top:1px solid var(--border-color); border-bottom:none; }
      .modal h3{ margin:0; font-size:18px; }
      .modal .content{ padding:14px 16px; max-height:70vh; overflow:auto; }
      .s2-row{ margin:12px 0; }
      .s2-title{ font-weight:700; margin-bottom:6px; }
      .s2-hint{ color: var(--text-secondary); font-size:13px; margin-top:4px; }
      .s2-input{ width:100%; box-sizing:border-box; }
      textarea.s2-input{ min-height:70px; resize:vertical; }
      .save-status{ font-size:12px; color: var(--text-secondary); }

      /* Agenda (Step 3 inline) */
      .agenda-wrap{ margin-top:10px; }
      .agenda-head{ display:flex; align-items:baseline; gap:10px; }
      .agenda-title{ font-weight:800; }
      .agenda-list{ display:grid; }
      .sel-item{ display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border-color); padding:6px 0; }
      .sel-item:last-child{ border-bottom:none; }
      .agenda-input-row{ display:flex; gap:8px; margin-top:8px; }

      /* Loading modal */
      #loadingModal{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; }
      #loadingModal .modal{ width:min(420px, 92vw); }
      .loading{ padding:20px; display:flex; flex-direction:column; align-items:center; gap:12px; }
      .spinner{ width:36px; height:36px; border:3px solid color-mix(in srgb, var(--purple) 30%, transparent); border-top-color:var(--purple); border-radius:50%; animation:spin .9s linear infinite; }
      @keyframes spin{ to{ transform: rotate(360deg); } }

      .hide{ display:none !important; }

      /* Inline expansion row */
      .t-inline{ display: grid; grid-template-columns: 28px 1fr; gap: 14px; padding: 6px 0 12px; }
      .t-inline .t-spacer{ width: 18px; height: 18px; border-radius: 999px; }
      .t-inline .t-inline-body{ padding: 4px 0; }

      .timeline.card{ padding: var(--tl-pad-y) 14px var(--tl-pad-y) var(--left-gutter) !important; }

      /* Month pager */
      .ov-holder{ position:relative; }
      .ov-bar{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:8px; }
      .ov-bar > #landingInline{ min-width:0; }
      .ov-nav{
          width:32px; height:32px;
          display:flex; align-items:center; justify-content:center;
          border:1px solid var(--border-color); background: var(--bg-secondary); border-radius:999px;
          box-shadow:var(--shadow-sm);
          cursor:pointer; font-size:18px; line-height:1;
          transition: transform 0.2s ease-out;
      }
      .ov-nav:hover:not(:disabled) { transform: scale(1.1); }
      .ov-nav:disabled{ opacity:.45; cursor:default; }
      
      /* Agenda alignment and sizing */
      #s3Mount.agenda-wrap{ width: min(100%, var(--agenda-width)); max-width: var(--agenda-width); margin-left: 0; margin-right: auto; }
      #s3Mount .agenda-list{ display: grid; grid-template-columns: 1fr; justify-items: stretch; width: 100%; }
      #s3Mount .agenda-input-row{ width: 100%; }
      #s3Mount .sel-item{ width: 100%; }
      #s3Mount .agenda-input-row input[type="text"]{ flex: 1 1 400px; width: auto; min-width: 0; }
      #s3Mount .agenda-input-row .btn{ flex: 0 0 auto; }
      .t-step.align-top { align-items: flex-start; }
      .t-step.align-top .t-body { padding-top: 0; }
      .t-step.align-top .t-dot { align-self: flex-start; }
      #s3Mount:empty {
          margin: 0;
          padding: 0;
      }
      /* Ghost button */
      .btn.ghost{
          background:transparent;
          color: var(--purple);
          border: 1px solid var(--border-color);
      }
      .btn.ghost:disabled{ opacity:.6; cursor:default; }

      #s3Mount.agenda-wrap {
          /* Add the visual frame styles */
          background-color: var(--purple-light);
          padding: 16px;
          border-radius: 12px;

          /* Add vertical spacing from the title above */
          margin-top: 12px;

          /* These existing rules are still good */
          width: min(100%, var(--agenda-width));
          max-width: var(--agenda-width);
          margin-left: 0;
          margin-right: auto;
      }

      #s3Mount.agenda-wrap:empty {
          background-color: transparent;
          padding: 0;
          margin-top: 0;
      }
  </style>


</head>
<body>
  <!-- LOADING -->
  <div id="loadingModal" class="modal-backdrop" style="display:flex;">
    <div class="modal"><div class="loading"><div class="spinner"></div><div id="loadingMsg">Loading…</div></div></div>
  </div>

  <!-- PREP QUESTIONS MODAL (Step 2) -->
  <div id="prepModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3 id="prepTitle">Provide extra input to help prepare</h3>
        <div class="save-status" id="prepSaveTop">Not saved yet</div>
      </header>
      <div class="content" id="prepContent"></div>
      <footer>
        <div class="save-status" id="prepSaveBottom">Not saved yet</div>
        <div style="display:flex; gap:8px;">
          <button class="btn secondary" id="prepCloseBtn">Close</button>
          <button class="btn" id="prepSaveBtn" disabled>Save</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- CONFIRM BOOKING MODAL -->
  <div id="confirmModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>Confirm time</h3>
        <button class="link" id="closeConfirm">Close</button>
      </header>
      <div class="content">
        <p id="confirmWhen" class="notice"></p>
        <p id="confirmPrep" class="notice" style="display:none"></p>
        <div id="inviteList"></div>
        <button class="link" id="addInviteBtn">+ Add another</button>
        <input type="email" id="newInviteInput" class="hide" placeholder="Enter email" />
      </div>
      <footer>
        <button class="btn" id="confirmBtn">Confirm</button>
      </footer>
    </div>
  </div>

  <!-- HEADER -->
  <div class="h-wrap">
    <div id="eyebrow" class="h-eyebrow"></div>
    <div id="title" class="h-title"></div>
  </div>
  <div id="smallNotice" class="notice"></div>

  <!-- TIMELINE -->
  <div class="timeline card" id="timelineWrap">
    <div id="timeline"></div>
  </div>

<script>
  /* =====================
   * CONFIG / API ENDPOINTS
   * ===================== */
  const API_BASE = 'https://script.google.com/macros/s/AKfycbwqqw_6MRAR9zkkDg6-vUNNETC1UQpS0sdIF6iSh-zT29FbKOcZkkkN-x3aqkvdyI7f8A/exec';
  const token = (new URLSearchParams(location.search).get('token') || '').trim();

  /* =====================
   * STATE
   * ===================== */
  const state = {
    meta: null,
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
    weekCache: new Map(),
    monthWeeks: new Map(),
    currentWeek: null,
    confirmQuestions: [],
    suggestedInvitees: [],
    preselectedCustomerEmails: [],
    stateJSON: { version:1, lastEditedAtISO:null, prep:{answers:{}}, agenda:{items:[]} },
    calendarAccessOk: true,
    monthPager: { offset: 0, visible: 3 },
  };

  /* =====================
   * UTILITIES
   * ===================== */
  const $ = sel => document.querySelector(sel);
  function showLoading(msg){ $('#loadingMsg').textContent = msg || 'Loading…'; $('#loadingModal').style.display='flex'; }
  function hideLoading(){ $('#loadingModal').style.display='none'; }

  function apiGet(action, params){
    const qs = new URLSearchParams({ action, ...(params||{}) });
    return fetch(`${API_BASE}?${qs.toString()}&ts=${Date.now()}`, { cache:'no-store' }).then(r=>r.json());
  }
  function apiPost(action, params, body){
    const qs = new URLSearchParams({ action, ...(params||{}) });
    return fetch(`${API_BASE}?${qs.toString()}&ts=${Date.now()}`, {
      method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body||{})
    }).then(r=>r.json());
  }

  // dates
  function fmtDate(d, tz){ return new Intl.DateTimeFormat('en-GB', { timeZone: tz, weekday:'short', year:'numeric', month:'short', day:'numeric' }).format(d); }
  function fmtTime(d, tz){ return new Intl.DateTimeFormat('en-GB', { timeZone: tz, hour:'2-digit', minute:'2-digit', hour12:false }).format(d).replace(':','h'); }
  function fmtRange(s, e, tz){ return `${fmtTime(s,tz)}–${fmtTime(e,tz)}`; }
  function ymdKey(date, tz){ const p = new Intl.DateTimeFormat('en-GB',{ timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit'}).formatToParts(date); return `${p.find(x=>x.type==='year').value}-${p.find(x=>x.type==='month').value}-${p.find(x=>x.type==='day').value}`; }
  function todayKey(tz){ return ymdKey(new Date(), tz); }
  function plusDaysKey(key, n){ const d = new Date(key+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+n); return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`; }
  function mondayKey(key){ const d = new Date(key+'T00:00:00Z'); const js=d.getUTCDay(); const delta = js===0 ? -6 : 1-js; d.setUTCDate(d.getUTCDate()+delta); return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`; }
  function weekDaysFromMondayKey(mon){ return Array.from({length:7}, (_,i)=>plusDaysKey(mon,i)); }
  function isoWeekNumberFromKey(dayKey){ const d=new Date(dayKey+'T00:00:00Z'); const day=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-day); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d-yearStart)/86400000)+1)/7); }
  function formatWeekLabel(startISO){ const d=new Date(startISO); const m=d.toLocaleString('en-US',{month:'long', timeZone:'UTC'}); const day=d.getUTCDate(); const ord = (n)=>{const a=n%10,b=n%100; return (b>=11&&b<=13)?'th':(a===1?'st':a===2?'nd':a===3?'rd':'th')}; return `Week of ${m} ${day}${ord(day)}`; }

  function parseSlots(raw){
    return (raw || [])
      .map(s => ({
        start: new Date(s.start),
        end:   new Date(s.end),
        prep:  (s.prep && s.prep.start && s.prep.end)
          ? { start: new Date(s.prep.start), end: new Date(s.prep.end) }
          : null
      }))
      .filter(s => !isNaN(+s.start) && !isNaN(+s.end));
  }

  function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); } }
  const nextFrame = () => new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

  // options helpers
  function parseAllowedWeekdays(csv='Mon,Tue,Wed,Thu,Fri'){
    const map = {Sun:7, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6};
    return new Set(csv.split(',').map(s=>map[String(s).trim().slice(0,3)]).filter(Boolean));
  }
  function dayOfWeekFromKey(dayKey){ const js = new Date(dayKey+'T00:00:00Z').getUTCDay(); return js===0?7:js; }
  function buildMonthWeeks(weeks){
    const monthWeeks = new Map();
    (weeks||[]).forEach(w=>{ const ym = String(w.startISO).slice(0,7); if(!monthWeeks.has(ym)) monthWeeks.set(ym, []); monthWeeks.get(ym).push(w); });
    for(const arr of monthWeeks.values()) arr.sort((a,b)=>a.startISO.localeCompare(b.startISO));
    return monthWeeks;
  }
  function monthTitle(y, m){ return new Date(Date.UTC(y, m-1, 1)).toLocaleString('en-GB', { month:'long', year:'numeric' }); }
  
  // simple copy interpolation for titles
  function fill(str){
    const who         = state.meta?.colleagueFirstName || state.meta?.colleagueEmail || 'your contact';
    const customer    = state.meta?.customerName || state.meta?.accountName || '';
    const meetingType = state.meta?.meetingType || '';
    return String(str || '')
      .replace(/\$who\b/g, who)
      .replace(/\$customer\b/g, customer)
      .replace(/\$meetingType\b/g, meetingType);
  }

  function fmtMMMdd(d, tz){ return new Intl.DateTimeFormat('en-US',{ timeZone:tz, month:'short', day:'numeric' }).format(d); }
  function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
  function daysUntil(d){
    const n = Math.ceil((startOfDay(d) - startOfDay(new Date())) / 86400000);
    return n; // 0=today, 1=tomorrow, 2=in 2 days, etc.
  }

  // Build the token context for titles
  function buildTemplateCtx(cfg){
    const who = state.meta?.colleagueFirstName || state.meta?.colleagueEmail || 'your contact';
    const mt  = state.meta?.meetingType || 'session';
    const tz  = state.tz;

    const evStart   = cfg.selectedStart || null;
    const prepStart = state.meta?.bookedPrepStartISO ? new Date(state.meta.bookedPrepStartISO) : null;
    const durMs     = (state.meta?.durationMins || 30) * 60000;

    return {
      who,
      meetingtype: mt,
      days: evStart ? daysUntil(evStart) : '',
      ev_date: evStart ? fmtMMMdd(evStart, tz) : '',
      ev_date_long: evStart ? fmtDate(evStart, tz) : '',
      ev_time: evStart ? fmtRange(evStart, new Date(evStart.getTime()+durMs), tz) : '',
      prep_date: prepStart ? fmtMMMdd(prepStart, tz) : '',
      prep_date_long: prepStart ? fmtDate(prepStart, tz) : ''
    };
  }

  // Replace tokens like $who, $days, $prep_date in a string
  function fill(str, ctx){
    return String(str||'').replace(/\$(who|meetingtype|days|ev_date|ev_date_long|ev_time|prep_date|prep_date_long)\b/g,
      (_,k)=> (ctx?.[k] ?? '')
    );
  }

  function detectCalendarAccess(meta) {
    const ca = meta?.calendarAccess;
    if (!ca) return false;
    if (ca.ok === true)  return true;
    if (ca.ok === false) return false;

    const s = (ca.status || '').toUpperCase();
    if (s === 'OK') return true;
    if (['NEEDS_AUTH','EXPIRED','MISSING_SCOPE','NO_ACCESS'].includes(s)) return false;

    return false; // unknown -> treat as not bookable
  }

  /* =====================
   * META / INIT
   * ===================== */
  async function init(){
    if(!token){ alert('Missing token in URL (?token=...)'); return; }
    showLoading('Loading meeting details…');
    try{
      const meta = await apiGet('getInviteMeta', { token });
      state.meta = meta; // keep raw for now
      state.calendarAccessOk = detectCalendarAccess(meta);

      // parse stateJSON
      let sj = meta.stateJSON; if(typeof sj==='string'){ try{ sj=JSON.parse(sj);}catch{ sj=null; } }
      state.stateJSON = sj && typeof sj==='object' ? sj : { version:1, lastEditedAtISO:null, prep:{answers:{}}, agenda:{items:[]} };

      // questions
      const cq = meta.confirmQuestions || meta.confirmQuestionsJSON || meta.confirmQuestion || [];
      state.confirmQuestions = Array.isArray(cq) ? cq : (cq ? [cq] : []);

      // invitees
      if(Array.isArray(meta.suggestedInvitees)) state.suggestedInvitees = meta.suggestedInvitees;
      if(Array.isArray(meta.preselectedCustomerEmails)) state.preselectedCustomerEmails = meta.preselectedCustomerEmails;

      // header copy
      const customer = meta.customerName || meta.accountName || '';
      const who = meta.colleagueFirstName || meta.colleagueEmail || '';
      const mt = meta.meetingType || 'Design session';
      $('#eyebrow').textContent = `${customer ? customer+' & ' : ''}Culture Amp`;
      $('#title').innerHTML = `${mt} with <span>${who}</span>`;
      $('#smallNotice').textContent = `Pick a week and we’ll search ${who || 'your contact'}’s calendar — including time for preparation when required.`;

      // weeks: locally generate the current quarter (past disabled)
      materializeInitialMonths();

      renderTimeline();
      hideLoading();
    }catch(e){ hideLoading(); alert((e && e.message) || 'Failed to load.'); }
  }

  /* =====================
   * TIMELINE RENDERING
   * ===================== */
  function derive(){
    const m = state.meta || {};

    const hasQs   = Array.isArray(state.confirmQuestions) && state.confirmQuestions.length > 0;
    const hasPrep = Number(m?.options?.prepDurationMins || 0) > 0;

    const sel   = getPrimarySelectedStart(m);
    const now   = new Date();
    const booked = !!sel;
    const future = booked && sel > now;

    const answers = (state.stateJSON?.prep?.answers) || {};
    const allAnswered = hasQs
      ? state.confirmQuestions.every((q,i)=>{
          const k = String(q?.key || ('q'+i));
          const v = answers[k];
          return !(v == null || (Array.isArray(v) ? v.length === 0 : String(v).trim() === ''));
        })
      : true;

    const prepStartISO = m?.bookedPrepStartISO || null;
    const prepEndISO   = m?.bookedPrepEndISO   || null;

    const prepStarted = !!prepStartISO && now >= new Date(prepStartISO);
    const prepEnded   = !!prepEndISO   && now >= new Date(prepEndISO);

    return {
      hasQs, hasPrep, booked, future,
      selectedStart: sel, allAnswered,
      prepStarted, prepEnded
    };
  }


  function renderTimeline(){
    const t = $('#timeline'); if(!t) return; t.innerHTML = '';
    const cfg = derive();
    const tpl = buildTemplateCtx(cfg);
    const S = (s, extra) => fill(s, { ...tpl, ...(extra||{}) });


    const steps = [];

    // STEP 1 — Find a time
    const step1 = document.createElement('div'); step1.className='t-step';
    step1.innerHTML = `<div class="t-dot ${cfg.booked? 'done' : 'active'}"></div>
      <div class="t-body">
        <div class="t-title">${
          cfg.booked
            ? S('Meeting booked for $ev_date ($days days from now)')
            : S('Find a time to meet with $who')
        }</div>
        <div class="t-sub" id="s1Sub">${cfg.booked ? whenLine(cfg.selectedStart) : 'Choose a week to see available times.'}</div>
        <div class="t-cta" id="s1Cta"></div>
      </div>`;
    steps.push(step1);

    // INLINE ROW (hidden until "View availability" is clicked)
    if(!cfg.booked){
      const inlineRow = document.createElement('div');
      inlineRow.className = 't-inline hide';
      inlineRow.id = 'landingRow';
      inlineRow.innerHTML = `
        <div class="t-spacer"></div>
        <div class="t-inline-body">
          <div class="ov-bar">
            <button type="button" class="ov-nav" id="ovPrev" aria-label="Previous months">‹</button>
            <div id="landingInline"></div>
            <button type="button" class="ov-nav" id="ovNext" aria-label="Next months">›</button>
          </div>
        </div>`;
      steps.push(inlineRow);
    }

    // STEP 2 — Prep Qs (only if hasQs)
    if(cfg.hasQs){
      const step2 = document.createElement('div'); step2.className='t-step';
      const dotClass = cfg.booked && cfg.allAnswered ? 'done' : (cfg.booked ? 'active' : '');
      step2.innerHTML = `<div class="t-dot ${dotClass}"></div>
        <div class="t-body">
          <div class="t-title">${
            cfg.booked
              ? S('Provide some extra input before $prep_date to help $who prepare')
              : S('Provide some extra input to help $who prepare')
          }</div>
          <div class="t-sub" id="s2Sub">${cfg.booked ? (cfg.allAnswered?'You can review your answers.':'Share input so we can prepare.') : 'Available after you book.'}</div>
          <div class="t-cta" id="s2Cta"></div>
        </div>`;
      steps.push(step2);
    }

    // STEP 3 — Agenda (inline, after booking)
    const step3 = document.createElement('div'); step3.className = 't-step align-top';
    step3.innerHTML = `
      <div class="t-dot ${cfg.booked ? (cfg.hasQs && !cfg.allAnswered ? '' : 'active') : ''}"></div>
      <div class="t-body">
        <div class="t-title">${S('Co-create the agenda, share your questions')}</div>
        <div class="t-cta" id="s3Cta"></div>
        <div class="t-sub" id="s3Sub">${cfg.booked ? 'Add items below.' : 'Available after you book.'}</div>
        <div id="s3Mount" class="agenda-wrap"></div>
      </div>`;
    steps.push(step3);


    // STEP 4 — Prep window (if required)
    if (cfg.hasPrep) {
      const step4 = document.createElement('div');
      step4.className = 't-step';

      const title = cfg.booked
        ? S(`$prep_date: We've held time in $who's calendar to prepare`)
        : 'We’ll hold time to prepare';

      // dot: empty until prep start time, then done
      const dotClass = cfg.prepStarted ? 'done' : '';

      step4.innerHTML = `
        <div class="t-dot ${dotClass}"></div>
        <div class="t-body">
          <div class="t-title">${title}</div>
          <div class="t-sub" id="prepWindowLine">
            ${cfg.booked ? prepWindowLine() : 'We’ll hold time once you’ve booked.'}
          </div>
        </div>`;
      steps.push(step4);
    }

    // STEP 5 — Meet
    const step5 = document.createElement('div'); step5.className='t-step';
    step5.innerHTML = `<div class="t-dot"></div>
      <div class="t-body">
        <div class="t-title">${
          cfg.booked
            ? S('$ev_date: Confirmed $meetingtype set with $who')
            : S('Meet to discuss!')
        }</div>
        <div class="t-sub" id="meetLine">${cfg.booked ? eventLine(cfg.selectedStart) : ''}</div>
      </div>`;
    steps.push(step5);


    // mount all steps
    steps.forEach(s=>t.appendChild(s));

    // Wire CTAs
    const s1Cta = $('#s1Cta');
    if(!cfg.booked){
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='View availability';
      btn.onclick = () => {
        const row = document.getElementById('landingRow');
        if(row){ row.classList.remove('hide'); showInlineOverview(); row.scrollIntoView({behavior:'smooth', block:'nearest'}); }
      };
      s1Cta.appendChild(btn);
    } else {
      // after booking, remove any inline content
      const li = $('#landingInline'); if(li) li.innerHTML = '';
    }

    if (cfg.hasQs){
      const s2Cta = $('#s2Cta'); s2Cta.innerHTML='';
      if (cfg.booked){
        const btn = document.createElement('button');
        const isDone = cfg.allAnswered;
        btn.className = isDone ? 'btn ghost' : 'btn';   // 👈 ghost only for “Review input”
        btn.textContent = isDone ? 'Review input' : 'Share input';
        btn.onclick = openPrepModal;
        s2Cta.appendChild(btn);
      }
    }

    if (cfg.booked){
      const s3Mount = $('#s3Mount');
      const s3Cta   = $('#s3Cta');

      // Show the toggle ONLY if there are no questions OR questions aren't complete.
      const showAgendaToggle = (!cfg.hasQs) || (cfg.hasQs && !cfg.allAnswered);

      // Visibility defaults:
      // - force OPEN when questions are complete
      // - else remember prior choice, or default open when no questions / closed when questions exist
      if (cfg.hasQs && cfg.allAnswered) {
        state.agendaVisible = true;            // force open when complete
      } else if (typeof state.agendaVisible !== 'boolean') {
        state.agendaVisible = !cfg.hasQs ? true : false;
      }

      function paintAgenda(){
        s3Mount.innerHTML = '';
        if (state.agendaVisible) renderAgendaInline();
        paintAgendaBtn();
      }

      function paintAgendaBtn(){
        s3Cta.innerHTML = '';
        if (!showAgendaToggle) return;          // 👈 no button when complete
        const btn = document.createElement('button');
        btn.className = 'btn ghost';
        btn.textContent = state.agendaVisible ? 'Hide Agenda' : 'Review Agenda';
        btn.onclick = () => { state.agendaVisible = !state.agendaVisible; paintAgenda(); };
        s3Cta.appendChild(btn);
      }

      paintAgenda();
    }
  }


  function whenLine(start){
    if(!start) return '';
    const end = new Date((state.meta?.durationMins||30)*60000 + start.getTime());
    return `${fmtDate(start, state.tz)} • ${fmtRange(start, end, state.tz)}`;
  }
  function eventLine(start){ return whenLine(start); }
  function prepWindowLine(){
    const s = state.meta?.bookedPrepStartISO ? new Date(state.meta.bookedPrepStartISO) : null;
    if(!s) return 'We inserted a calendar hold to allow time to prepare.';
    return `We inserted a calendar hold on ${fmtDate(s, state.tz)} at ${fmtTime(s, state.tz)} to prepare.`;
  }

  function getPrimarySelectedStart(meta){
    let arr=[]; try{
      if(Array.isArray(meta.selectedStartsJSON)) arr = meta.selectedStartsJSON;
      else if(typeof meta.selectedStartsJSON==='string' && meta.selectedStartsJSON.trim()) arr = JSON.parse(meta.selectedStartsJSON);
    }catch{}
    const dates = (arr||[]).map(s=>new Date(s)).filter(d=>!isNaN(+d));
    if(!dates.length && meta.bookedStartISO){ const d=new Date(meta.bookedStartISO); return isNaN(+d)?null:d; }
    if(!dates.length) return null;
    const now=new Date(); const future=dates.filter(d=>d>now).sort((a,b)=>a-b); if(future.length) return future[0]; return dates.sort((a,b)=>b-a)[0];
  }

  /* =====================
   * INLINE OVERVIEW / WEEK
   * ===================== */
  function renderInlineOverviewShell(){
    const mount = $('#landingInline'); if(!mount) return; mount.innerHTML = '';
    const holder = document.createElement('div'); holder.id='inlineHolder'; mount.appendChild(holder);
    showInlineOverview();
  }

  function showInlineOverview(){
    const mount = $('#landingInline'); if(!mount) return; mount.innerHTML='';

    // all months we have, sorted (e.g. 2025-09, 2025-10, …)
    const monthsAll = [...state.monthWeeks.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    const total     = monthsAll.length;
    const visCount  = Math.max(1, Number(state.monthPager?.visible || 3));

    // clamp offset
    const maxOffset = Math.max(0, total - visCount);
    const start     = Math.min(Math.max(0, Number(state.monthPager?.offset || 0)), maxOffset);

    // slice the visible window
    const months = monthsAll.slice(start, start + visCount);

    // render the month cards grid
    const grid = document.createElement('div');
    grid.className = 'ov-grid';

    months.forEach(([ym,weeks])=>{
      const [y,m] = ym.split('-').map(Number);
      const card  = document.createElement('div'); card.className='mcard';

      const head  = document.createElement('div'); head.className='mhead';
      const name  = document.createElement('div'); name.className='mname'; name.textContent = monthTitle(y,m);
      head.appendChild(name); card.appendChild(head);

      const list  = document.createElement('div');
      list.className = 'week-list';
      weeks.forEach(w=>{
        const btn = document.createElement('button'); btn.className='week-pill';
        btn.textContent = `${formatWeekLabel(w.startISO)} — Wk ${w.weekNum}`;
        const monKey = w.startISO.slice(0,10);
        if(!w.selectable){ btn.classList.add('disabled'); btn.disabled=true; }
        else { btn.onclick = ()=> openWeekInline(monKey); }
        list.appendChild(btn);
      });

      card.appendChild(list);
      grid.appendChild(card);
    });

    mount.appendChild(grid);

    // update chevrons (always visible, disabled when not relevant)
    const prevBtn = $('#ovPrev');
    const nextBtn = $('#ovNext');
    const canPrev = start > 0;
    const canNext = start + visCount < total;

    if (prevBtn){
      prevBtn.disabled = !canPrev;
      prevBtn.onclick = () => {
        state.monthPager.offset = Math.max(0, start - 1);
        showInlineOverview();
      };
    }
    if (nextBtn){
      nextBtn.disabled = !canNext;
      nextBtn.onclick = () => {
        state.monthPager.offset = Math.min(start + 1, maxOffset);
        showInlineOverview();
      };
    }
  }

  // ---- Week loading: coarse → fine -------------------------------------------
  async function fetchWeekAtGranularity(monKey, g){
    const res = await apiGet('fetchWeek', { token, mondayKey: monKey, g });
    return parseSlots(res && res.slots ? res.slots : []);
  }

  function mergeSlotsUnique(arrays){
    const map = new Map(); // key by start|end so different lengths don't collide
    arrays.flat().forEach(s => {
      const key = `${s.start.toISOString()}|${s.end.toISOString()}`;
      if (!map.has(key)) map.set(key, s);
    });

    // Prefer :00, :30, then :15/:45; then earlier times
    const rank = m => ({0:0,30:1,15:2,45:3}[m % 60] ?? 99);
    return [...map.values()].sort((a,b)=>{
      const ra = rank(a.start.getMinutes()), rb = rank(b.start.getMinutes());
      return ra !== rb ? ra - rb : a.start - b.start;
    });
  }

  async function loadWeekCoarseToFine(monKey, { minSlots = 3, prefetch = false } = {}){
    if (!prefetch) showLoading('Scanning for availability…');

    const passes = [
      { g: 60, msg: 'Scanning for availability…' },
      { g: 30, msg: 'Looking for prep slots…' },
      { g: 15, msg: 'Taking a closer look…' },
    ];

    const batches = [];
    for (let i = 0; i < passes.length; i++){
      const { g, msg } = passes[i];
      const batch = await fetchWeekAtGranularity(monKey, g);
      batches.push(batch);

      const merged = mergeSlotsUnique(batches);
      if (!prefetch && merged.length < minSlots && i < passes.length-1) showLoading(msg);
      if (merged.length >= minSlots){
        const payload = { slotsParsed: merged, exactCount: merged.length };
        state.weekCache.set(monKey, payload);
        return payload;
      }
    }

    const merged = mergeSlotsUnique(batches);
    const payload = { slotsParsed: merged, exactCount: merged.length };
    state.weekCache.set(monKey, payload);
    return payload;
  }

  async function ensureWeekLoaded(monKey){
    if (state.weekCache.has(monKey)) return state.weekCache.get(monKey);
    return loadWeekCoarseToFine(monKey); // progressive search (60 → 30 → 15)
  }

  async function openWeekInline(monKey){
    state.currentWeek = monKey;
    showLoading('Loading this week…');
    try{
      const payload = await ensureWeekLoaded(monKey);
      renderWeekInline(payload, monKey);

      // prefetch adjacent weeks in the background
      [plusDaysKey(monKey,-7), plusDaysKey(monKey,7)].forEach(k=>{
        if (!state.weekCache.has(k)) loadWeekCoarseToFine(k, { prefetch: true, minSlots: 1 });
      });
    } catch(e){
      alert('Failed to load week.');
    } finally {
      hideLoading();
    }
  }

  function renderWeekInline(payload, monKey){
    const mount = $('#landingInline'); if(!mount) return; mount.innerHTML='';
    const wrap = document.createElement('div'); wrap.className='week-wrap';

    const head = document.createElement('div'); head.className='week-head';
    const back = document.createElement('button'); back.className='nav-btn'; back.textContent='← Back to weeks'; back.onclick = showInlineOverview;
    const title = document.createElement('div'); title.className='week-title'; const d=new Date(monKey+'T00:00:00Z'); title.textContent = `${d.toLocaleString('en-GB',{month:'long',year:'numeric'})} • Week ${isoWeekNumberFromKey(monKey)}`;
    const nav = document.createElement('div'); nav.style.display='flex'; nav.style.gap='8px';
    const prev=document.createElement('button'); prev.className='nav-btn'; prev.textContent='←'; prev.onclick=()=>openWeekInline(plusDaysKey(monKey,-7));
    const next=document.createElement('button'); next.className='nav-btn'; next.textContent='→'; next.onclick=()=>openWeekInline(plusDaysKey(monKey,7));
    nav.append(prev,next); head.append(back,title,nav); wrap.appendChild(head);

    const grid=document.createElement('div'); grid.className='grid';
    const gh=document.createElement('div'); gh.className='grid-header'; gh.innerHTML='<div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>'; grid.appendChild(gh);
    const daysEl=document.createElement('div'); daysEl.className='days';

    const days = weekDaysFromMondayKey(monKey); const today = todayKey(state.tz);
    const byDay = new Map(days.map(k=>[k,[]])); (payload.slotsParsed||[]).forEach(s=>{ const key=ymdKey(s.start,state.tz); if(byDay.has(key)) byDay.get(key).push(s); }); days.forEach(k=>byDay.get(k).sort((a,b)=>a.start-b.start));

    days.forEach(dayKey=>{
      const col=document.createElement('div'); col.className='day'+(dayKey<today?' past':'');
      const header=document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center'; header.className='day-header';
      const dateEl=document.createElement('div'); dateEl.className='date'; dateEl.textContent=Number(dayKey.slice(-2)); header.appendChild(dateEl); col.appendChild(header);
      const body=document.createElement('div'); body.className='day-body';

      (byDay.get(dayKey)||[]).forEach(slot=>{
        const pill=document.createElement('button'); pill.type='button'; pill.className='pill';
        const icon=document.createElement('span'); icon.className='icon'; icon.textContent='○';
        const label=document.createElement('span'); label.textContent=`${fmtTime(slot.start,state.tz)} – ${fmtTime(slot.end,state.tz)}`;
        pill.append(icon,label);
        pill.onclick=()=>{ document.querySelectorAll('.pill.selected').forEach(el=>{ if(el!==pill){ el.classList.remove('selected'); el.querySelector('.icon').textContent='○'; }}); pill.classList.add('selected'); icon.textContent='✓'; openConfirmModal(slot); };
        body.appendChild(pill);
      });

      col.appendChild(body); daysEl.appendChild(col);
    });

    grid.appendChild(daysEl); wrap.appendChild(grid);

    const meta=document.createElement('div'); meta.className='notice'; meta.textContent=`Found ${payload.exactCount||0} slot${(payload.exactCount||0)===1?'':'s'}.`; wrap.appendChild(meta);

    if((payload.exactCount||0)===0){ const banner=document.createElement('div'); banner.className='card'; banner.style.background='#f9fafb'; banner.style.textAlign='center'; banner.textContent='No weeks available'; wrap.appendChild(banner); }

    mount.appendChild(wrap);
  }

  /* =====================
   * CONFIRM MODAL
   * ===================== */
  function openConfirmModal(slot){

  (function applyCalendarGate(){
    const confirmBtn  = document.getElementById('confirmBtn');
    const inviteList  = document.getElementById('inviteList');
    const addInvite   = document.getElementById('addInviteBtn');
    const newInvite   = document.getElementById('newInviteInput');
    const qWrap       = document.getElementById('confirmPrep'); // or another section you want hidden
    const footer      = document.querySelector('#confirmModal footer');

    // remove any prior banner
    footer?.querySelector('.no-cal-msg')?.remove();

    if (!state.calendarAccessOk) {
      // hide booking actions & inputs
      if (confirmBtn) confirmBtn.style.display = 'none';
      if (inviteList) inviteList.style.display = 'none';
      if (addInvite)  addInvite.style.display  = 'none';
      if (newInvite)  newInvite.style.display  = 'none';
      if (qWrap)      qWrap.style.display      = 'none';

      // add a friendly fallback message
      const name  = state?.meta?.colleagueFirstName || state?.meta?.colleagueEmail || 'your contact';
      const email = state?.meta?.colleagueEmail || '';
      const msg   = document.createElement('div');
      msg.className = 'no-cal-msg notice';
      msg.textContent = email
        ? `${name} hasn’t connected their calendar yet, so we can’t book automatically here. Please email ${email} to request this slot.`
        : `${name} hasn’t connected their calendar yet, so we can’t book automatically here. Please reach out directly to request this slot.`;
      footer?.prepend(msg);
    } else {
      // ensure everything is visible if access is OK
      if (confirmBtn) confirmBtn.style.display = '';
      if (inviteList) inviteList.style.display = '';
      if (addInvite)  addInvite.style.display  = '';
      if (newInvite)  newInvite.style.display  = '';
      if (qWrap)      qWrap.style.display      = '';
    }
  })();

    const confirmModal = $('#confirmModal'); const confirmBtn = $('#confirmBtn');
    const when = `${fmtDate(slot.start, state.tz)} • ${fmtRange(slot.start, slot.end, state.tz)}`;
    $('#confirmWhen').textContent = when;

    const cp = $('#confirmPrep'); cp.style.display='none'; cp.textContent='';
    if(slot.prep && slot.prep.start){ cp.style.display=''; cp.textContent = `${(state.meta?.colleagueFirstName||'They')} would begin preparing on ${fmtDate(slot.prep.start,state.tz)} at ${fmtTime(slot.prep.start,state.tz)}.`; }

    // simple invitees list (preselected only)
    const inviteList = $('#inviteList'); inviteList.innerHTML='';
    const norm=s=>String(s||'').trim(); const isEmail=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(norm(s));
    const suggested=(state.suggestedInvitees||[]).map(norm).filter(isEmail);
    const pre=(state.preselectedCustomerEmails||[]).map(norm).filter(isEmail);
    const lcSet=new Set(pre.map(e=>e.toLowerCase()));

    const candidates = Array.from(new Set([...suggested, ...pre])).slice(0,15);
    const selected = new Set(pre.map(e=>e.toLowerCase()));

    function paint(){
      inviteList.innerHTML='';
      if(!candidates.length){ const p=document.createElement('p'); p.className='notice'; p.textContent='Add at least one attendee email to proceed.'; inviteList.appendChild(p); }
      candidates.forEach((email)=>{
        const row=document.createElement('label'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.margin='6px 0';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=selected.has(email.toLowerCase()); cb.onchange=()=>{ if(cb.checked) selected.add(email.toLowerCase()); else selected.delete(email.toLowerCase()); validate(); };
        const span=document.createElement('span'); span.textContent=email; row.append(cb,span); inviteList.appendChild(row);
      });
      validate();
    }
    function validate(){ confirmBtn.disabled = selected.size===0; }
    paint();

    $('#addInviteBtn').onclick = ()=>{ const inp=$('#newInviteInput'); inp.classList.toggle('hide'); if(!inp.classList.contains('hide')) inp.focus(); };
    $('#newInviteInput').onkeydown = (e)=>{ if(e.key==='Enter'){ const raw=e.target.value.trim(); if(isEmail(raw) && !candidates.includes(raw)){ candidates.push(raw); selected.add(raw.toLowerCase()); e.target.value=''; paint(); } } }; 

    confirmBtn.textContent='Confirm'; confirmBtn.classList.remove('success','error');
    confirmBtn.onclick = async ()=>{
      if (!state.calendarAccessOk) return;
      if(selected.size===0){ alert('Please add at least one attendee email.'); return; }
      confirmBtn.disabled=true; confirmBtn.textContent='Booking…'; showLoading('Booking your time…'); await nextFrame();
      try{
        // persist invitees (fire-and-forget)
        apiPost('saveSuggestedInvitees', { token }, { emails: candidates }).catch(()=>{});
        apiPost('saveCustomerEmails', { token }, { emails: Array.from(selected) }).catch(()=>{});

        const iso = slot.start.toISOString();
        
        // derive preferred prep (if present)
        const preferredPrep = (slot.prep && slot.prep.start && slot.prep.end)
          ? { start: slot.prep.start.toISOString(), end: slot.prep.end.toISOString() }
          : null;

        // ✅ only the CHECKED emails, preserving original casing from `candidates`
        const selLC = new Set(Array.from(selected));                // selected is lowercased
        const explicitCustomerEmails = candidates.filter(e => selLC.has(e.toLowerCase()));

        const extra = {
          explicitCustomerEmails,            // ✅ matches your older FE
          customerEmails: explicitCustomerEmails, // fallback if BE reads this key
          ...(preferredPrep ? { [iso]: preferredPrep } : {})
        };
        if(slot.prep && slot.prep.start && slot.prep.end){ extra[iso] = { start: slot.prep.start.toISOString(), end: slot.prep.end.toISOString() }; }
        const resp = await apiPost('reserveSlots', { token }, { slots:[iso], extra });
        const c = resp?.confirmed?.[iso];
        if(!c) throw new Error('Booking failed');

        // reflect in meta
        state.meta.bookedStartISO = c.start; state.meta.bookedEndISO = c.end || new Date(slot.start.getTime() + (state.meta.durationMins||30)*60000).toISOString();
        if(c.prep?.start && c.prep?.end){ state.meta.bookedPrepStartISO = c.prep.start; state.meta.bookedPrepEndISO = c.prep.end; }
        state.meta.selectedStartsJSON = [c.start]; state.meta.status='USED';

        hideLoading(); confirmModal.style.display='none';
        renderTimeline();
      }catch(e){ hideLoading(); alert((e && e.message) || 'Could not book.'); confirmBtn.disabled=false; confirmBtn.textContent='Try again'; }
    };

    $('#closeConfirm').onclick = ()=>{ confirmModal.style.display='none'; };
    confirmModal.style.display='flex';
  }

  /* =====================
   * STEP 2 — PREP QUESTIONS MODAL
   * ===================== */
  function openPrepModal(){
      const modal = $('#prepModal'); const content = $('#prepContent'); content.innerHTML='';
      const who = state.meta?.colleagueFirstName || 'your People Scientist';
      $('#prepTitle').textContent = `Help ${who} prepare`;

      let dirty=false; const markDirty=()=>{ dirty=true; $('#prepSaveBtn').disabled=false; updateSaveStamps(true); };

      function getAns(k){ return state.stateJSON?.prep?.answers?.[k]; }
      function setAns(k,v){ if(!state.stateJSON.prep) state.stateJSON.prep={answers:{}}; if(!state.stateJSON.prep.answers) state.stateJSON.prep.answers={}; state.stateJSON.prep.answers[k]=v; markDirty(); }

      const ctx = { colleagueFirstName: who, customerName: state.meta?.customerName || state.meta?.accountName || '', meetingType: state.meta?.meetingType || '' };
      const interp = (s)=> String(s||'').replace(/\$\{(\w+)\}/g,(_,k)=> ctx[k] ?? '');

      const questions = state.confirmQuestions || [];
      questions.forEach((q,idx)=>{
          const key = String(q?.key || ('q'+idx));
          const typeRaw = (q?.type || q?.questionType || q?.input || (q?.multi? 'multi': 'single')).toString().toLowerCase();
          const type = (typeRaw==='checkbox' || typeRaw==='checkboxes') ? 'multi' : (typeRaw==='textarea'?'text':typeRaw);
          const label = interp(q?.label || 'Question');

          const row = document.createElement('div'); row.className='s2-row';
          const title = document.createElement('div'); title.className='s2-title'; title.textContent = label; row.appendChild(title);

          if(type==='text'){
              const multiline = !!q?.multiline; const maxLength = Number(q?.maxLength||0) || undefined; const saved = getAns(key) ?? q?.saved ?? '';
              let input; if(multiline){ input=document.createElement('textarea'); } else { input=document.createElement('input'); input.type='text'; }
              input.className='s2-input'; input.placeholder = interp(q?.placeholder || ''); if(maxLength) input.maxLength = maxLength; input.value = String(saved||'');
              input.addEventListener('input', debounce(()=> setAns(key, String(input.value||'').trim()), 200)); row.appendChild(input);
          } else if(type==='multi'){
              const opts = parseOptionsLoose(q?.options).map(cleanLabel).map(interp);
              let saved = getAns(key); if(!Array.isArray(saved)) saved = saved==null ? [] : [String(saved)]; const sel = new Set(saved.map(String));
              const maxSel = Number(q?.maxSelections || 0) || Infinity;
              opts.forEach(opt=>{
                  const id = `pm_${key}_${opt.replace(/\W+/g,'_')}`; const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px'; wrap.style.margin='6px 0';
                  const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.checked=sel.has(opt);
                  cb.onchange=()=>{ const cur=new Set(getAns(key)||[]); if(cb.checked){ if(cur.size>=maxSel){ cb.checked=false; alert(`You can select up to ${maxSel}.`); return; } cur.add(opt); } else { cur.delete(opt); } setAns(key, Array.from(cur)); };
                  const lab=document.createElement('label'); lab.setAttribute('for', id); lab.textContent=opt; wrap.append(cb,lab); row.appendChild(wrap);
              });
          } else {
              const opts = parseOptionsLoose(q?.options).map(cleanLabel).map(interp); const saved = getAns(key) ?? (q?.saved!=null ? cleanLabel(q.saved): null);
              opts.forEach(opt=>{ const id=`pm_${key}_${opt.replace(/\W+/g,'_')}`; const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px'; wrap.style.margin='6px 0';
                  const rb=document.createElement('input'); rb.type='radio'; rb.name=`pm_${key}`; rb.id=id; rb.value=opt; if(saved && String(saved)===opt) rb.checked=true; rb.onchange=()=> setAns(key, opt);
                  const lab=document.createElement('label'); lab.setAttribute('for', id); lab.textContent=opt; wrap.append(rb,lab); row.appendChild(wrap); });
          }
          content.appendChild(row);
      });

      function updateSaveStamps(showUnsaved){ const iso = state.stateJSON?.lastEditedAtISO; const stamp = showUnsaved? 'Unsaved changes' : (iso? fmtSaved(iso): 'Not saved yet'); $('#prepSaveTop').textContent = stamp; $('#prepSaveBottom').textContent = stamp; }
      function fmtSaved(iso){ const d = new Date(iso); if(isNaN(+d)) return 'Not saved yet'; const date = new Intl.DateTimeFormat('en-US', { timeZone: state.tz, month:'short', day:'2-digit', year:'numeric' }).format(d); const time = fmtTime(d, state.tz); return `Last saved on ${date} at ${time}`; }

      const saveBtn = $('#prepSaveBtn');
      saveBtn.textContent = 'Save and Close'; // Change button text

      saveBtn.onclick = async () => {
          saveBtn.textContent = 'Saving…';
          saveBtn.disabled = true;
          try {
              // 1. Perform the save
              state.stateJSON.lastEditedAtISO = new Date().toISOString();
              await apiPost('saveStateJSON', { token }, { stateJSON: state.stateJSON });
              
              // 2. On success, update UI and close modal
              dirty = false;
              updateSaveStamps(false);
              renderTimeline();
              modal.style.display = 'none'; // Close the modal

          } catch (e) {
              // 3. On failure, show an error and reset the button
              alert('Could not save right now. Please try again.');
              saveBtn.textContent = 'Save and Close'; // Reset text on failure
              saveBtn.disabled = false; // Re-enable for another try
          }
      };

      $('#prepCloseBtn').onclick = ()=>{ modal.style.display='none'; };

      updateSaveStamps(false);
      $('#prepSaveBtn').disabled = true; // will enable on edit
      modal.style.display='flex';
  }

  function parseOptionsLoose(raw){
    if(Array.isArray(raw)){ if(raw.length===1 && /^\s*\[/.test(raw[0])) { try{ const j=JSON.parse(raw[0]); return Array.isArray(j)? j: raw; } catch{} } return raw.map(String); }
    if(typeof raw==='string'){ const s=raw.trim(); if(s.startsWith('[') && s.endsWith(']')){ try{ const j=JSON.parse(s); if(Array.isArray(j)) return j; } catch{} } return s.split(/[\n,;|]/).map(x=>x.trim()).filter(Boolean); }
    return [];
  }
  function cleanLabel(s){ return String(s).replace(/^\s*\[/,'').replace(/\]\s*$/,'').replace(/^['"]|['"]$/g,'').replace(/''/g,"'"); }

  /* =====================
   * STEP 3 — AGENDA INLINE (auto-save on edit)
   * ===================== */
  function renderAgendaInline(){
    const mount = $('#s3Mount'); if(!mount) return; mount.innerHTML='';

    const head=document.createElement('div'); head.className='agenda-head';
    const title=document.createElement('div'); title.className='agenda-title'; title.textContent='Discussion points:'; head.appendChild(title);
    const stamp=document.createElement('div'); stamp.className='save-status'; stamp.style.marginLeft='auto'; stamp.id='agendaStamp'; head.appendChild(stamp);

    const list=document.createElement('div'); list.className='agenda-list'; list.id='agendaList';
    const addRow=document.createElement('div'); addRow.className='agenda-input-row';
    const input=document.createElement('input'); input.type='text'; input.placeholder='Add a question or agenda item…';
    const addBtn=document.createElement('button'); addBtn.className='btn secondary'; addBtn.textContent='Add';
    addRow.append(input, addBtn);

    mount.append(head, list, addRow);

    function items(){ return (state.stateJSON?.agenda?.items || []).slice().sort((a,b)=> (a.order||0)-(b.order||0)); }
    function nextOrder(){ return Math.max(0, ...items().map(x=>Number(x.order||0))) + 1; }
    function renumber(){ const arr = items(); arr.forEach((it,i)=> it.order=i+1); state.stateJSON.agenda.items = arr; }

    function paint(){ list.innerHTML=''; const arr=items(); arr.forEach((it,idx)=>{
      const row=document.createElement('div'); row.className='sel-item';
      const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px'; left.style.flex='1 1 auto';
      const bullet=document.createElement('span'); bullet.textContent='•'; left.appendChild(bullet);
      const txt=document.createElement('div'); txt.textContent=it.text; txt.style.flex='1 1 auto'; left.appendChild(txt);

      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px'; actions.style.flexShrink='0';
      const edit=document.createElement('button'); edit.className='link'; edit.textContent='Edit'; edit.onclick=()=> editItem(it, txt);
      const up=document.createElement('button'); up.className='link'; up.textContent='↑'; up.onclick=()=>{ if(idx===0) return; const a=arr[idx], b=arr[idx-1]; const tmp=a.order; a.order=b.order; b.order=tmp; renumber(); mark(); paint(); };
      const down=document.createElement('button'); down.className='link'; down.textContent='↓'; down.onclick=()=>{ if(idx>=arr.length-1) return; const a=arr[idx], b=arr[idx+1]; const tmp=a.order; a.order=b.order; b.order=tmp; renumber(); mark(); paint(); };
      const del=document.createElement('button'); del.className='link'; del.textContent='Remove'; del.onclick=()=>{ const src=state.stateJSON.agenda.items; const i=src.findIndex(x=>x.id===it.id); if(i>=0) src.splice(i,1); renumber(); mark(); paint(); };
      if(idx===0) up.style.visibility='hidden'; if(idx===arr.length-1) down.style.visibility='hidden';
      actions.append(edit, up, down, del);

      row.append(left, actions); list.appendChild(row);
    }); updateStamp(false); }

    function editItem(it, txtEl){ const inp=document.createElement('input'); inp.type='text'; inp.value=it.text; txtEl.replaceWith(inp); inp.focus(); inp.onkeydown=(e)=>{ if(e.key==='Enter'){ it.text=String(inp.value||'').trim(); mark(); paint(); } }; inp.onblur=()=>{ it.text=String(inp.value||'').trim(); mark(); paint(); } }
    function mark(){ state.stateJSON.lastEditedAtISO = new Date().toISOString(); debouncedSave(); updateStamp(true); }
    function updateStamp(unsaved){ const iso=state.stateJSON?.lastEditedAtISO; const s = unsaved? 'Unsaved changes' : (iso? fmtSaved(iso): 'Not saved yet'); $('#agendaStamp').textContent=s; }
    function fmtSaved(iso){ const d=new Date(iso); if(isNaN(+d)) return 'Not saved yet'; const date=new Intl.DateTimeFormat('en-US',{ timeZone: state.tz, month:'short', day:'2-digit', year:'numeric' }).format(d); const time=fmtTime(d,state.tz); return `Last saved on ${date} at ${time}`; }

    const debouncedSave = debounce(async ()=>{ try{ await apiPost('saveStateJSON', { token }, { stateJSON: state.stateJSON }); updateStamp(false); } catch{} }, 500);

    addBtn.onclick = ()=>{ const text=String(input.value||'').trim(); if(!text) return; input.value=''; if(!state.stateJSON.agenda) state.stateJSON.agenda={items:[]}; state.stateJSON.agenda.items.push({ id:'id_'+Math.random().toString(36).slice(2,9), text, order: nextOrder() }); mark(); paint(); };
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addBtn.click(); } });

    paint();
  }

  /* =====================
   * WEEKS DATA: current quarter (past disabled by minNotice)
   * ===================== */
  // add N months to a YYYY-MM-01 key
  function addMonthsKey(ymdKey, n){
    const d = new Date(ymdKey + 'T00:00:00Z');
    d.setUTCMonth(d.getUTCMonth() + n);
    return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-01`;
  }

  function generateWeeksForRange({
    startY,               // e.g. 2025
    startM,               // 1-12
    monthCount,           // how many months to include
    initialTz = 'UTC',
    minNoticeDays = 0,
    weekdaysCSV = 'Mon,Tue,Wed,Thu,Fri',
    blackoutDatesCSV = ''
  } = {}){
    const pad = n => String(n).padStart(2, '0');
    const startKey = `${startY}-${pad(startM)}-01`;
    const afterKey = addMonthsKey(startKey, monthCount);

    const allowed  = parseAllowedWeekdays(weekdaysCSV);
    const blackouts = new Set(String(blackoutDatesCSV||'')
                      .split(/[\s,]+/)
                      .filter(s => /^\d{4}-\d{2}-\d{2}$/.test(s)));
    const today    = todayKey(initialTz);
    const minStart = plusDaysKey(today, minNoticeDays);

    const out = [];
    for(let wk = mondayKey(startKey); wk < mondayKey(afterKey); wk = plusDaysKey(wk, 7)){
      const days = weekDaysFromMondayKey(wk);
      const selectable = days.some(d =>
        d >= minStart &&
        !blackouts.has(d) &&
        allowed.has(dayOfWeekFromKey(d))
      );
      out.push({
        startISO: new Date(wk + 'T00:00:00Z').toISOString(),
        weekNum:  isoWeekNumberFromKey(wk),
        selectable
      });
    }
    return out;
  }

  function materializeInitialMonths(){
    const meta = state.meta || {};
    const tz   = meta.initialTz || state.tz || 'UTC';

    // Controls (safe defaults)
    const monthsAhead  = Number(meta?.options?.monthsAhead  ?? 2); // current + next 2
    const monthsBehind = Number(meta?.options?.monthsBehind ?? 0); // usually 0
    const minSelectableWeeks = Number(meta?.options?.minSelectableWeeks ?? 0); // 0 = no requirement

    // Start month = current month minus monthsBehind
    const now   = new Date();
    const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - monthsBehind, 1));
    const startY = start.getUTCFullYear();
    const startM = start.getUTCMonth() + 1;
    const baseCount = monthsAhead + monthsBehind + 1; // include current month

    const gen = (count) => generateWeeksForRange({
      startY,
      startM,
      monthCount: 6,
      initialTz: tz,
      minNoticeDays: Number(meta?.options?.minNoticeDays || 0),
      weekdaysCSV:   String(meta?.options?.weekdaysCSV   || 'Mon,Tue,Wed,Thu,Fri'),
      blackoutDatesCSV: String(meta?.options?.blackoutDatesCSV || '')
    });

    // Make the initial set
    let weeks = gen(baseCount);

    // Optionally extend until we have enough selectable weeks (cap to +12 months extra)
    if (minSelectableWeeks > 0){
      let extra = 0;
      while (weeks.filter(w => w.selectable).length < minSelectableWeeks && extra < 12){
        extra += 1;
        weeks = gen(baseCount + extra);
      }
    }

    state.monthWeeks = buildMonthWeeks(weeks);
  }


  // kick off
  init();
</script>
</body>
</html>
