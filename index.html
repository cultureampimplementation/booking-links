<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Pick meeting times</title>
  <style>
    /* Hide app visuals and prevent scroll during boot */
    html.booting, body.booting { overflow: hidden; }
    .booting #app { visibility: hidden; }
    /* Ensure loader covers everything */
    #loadingModal { position: fixed; inset: 0; z-index: 9999; }
  </style>
  <script>document.documentElement.classList.add('booting');</script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px; }

    /* top controls */
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; position: sticky; top: 0; background: var(--bg, #fff); padding-bottom: 8px; z-index: 2; }
    select { padding: 8px; font-size: 14px; }
    .tabs { display: inline-flex; gap: 6px; border: 1px solid #e0e0e0; border-radius: 999px; padding: 2px; }
    .tab { padding: 6px 10px; border-radius: 999px; cursor: pointer; }
    .tab.active { background: #f0f4ff; font-weight: 600; }
    .nav-btn[disabled] { opacity:.5; cursor:default; }

    .cart { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .badge { padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; cursor: pointer; }
    .btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; background: #f7f7f7; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: default; }
    .success { background: #d8f5d1; border-color: #b4e3a8; }
    .error { background: #ffe2e2; border-color: #ffc7c7; }

    .notice { margin-top: 4px; color: #666; font-size: 13px; }
    .breadcrumb { margin-top: 6px; color: #666; font-size: 14px; }
    .breadcrumb a { color: inherit; text-decoration: underline; cursor: pointer; }

    /* ===== Overview (Months with Week rows) ===== */
    
    .ov-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, 320px);
      gap: 14px;
      justify-content: start;
      margin-top: 12px;
    }

    .mcard{
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      background: #fff;
      width: 100%;            /* was 320px */
      box-sizing: border-box; /* include borders/padding in width */
      /* optional safety: */
      min-width: 0;
      overflow: hidden;
    }
    .mcard:hover { box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .mhead { display: flex; align-items: baseline; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
    .mname { font-weight: 800; font-size: 18px; }
    .weeks { display: grid; gap: 10px; }
    .week-row:hover { box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .week-label { font-size: 13px; font-weight: 600; color: #333; }

    /* Clickable week pill */
    .week-pill{
      /* slightly darker default */
      background:#ede9fe;           /* lavender */
      color:#0f172a;
      border:1px solid rgba(15,23,42,.10);
      border-radius:10px;
      padding:10px 12px;
      font-weight:800; font-size:14px; line-height:1.1;
      cursor:pointer; user-select:none; text-align:left;
      box-shadow:inset 0 -1px 0 rgba(255,255,255,.6);
    }
    .week-pill:hover    { filter: brightness(1.02); }
    .week-pill:active   { transform: translateY(1px); }

    /* Force contrasting text when bg is dark */
    .week-pill.lightText{ color:#fff; }

    /* Zero availability: white with a hairline outline */
    .week-pill.zero{
      background:#fff; color:#0f172a;
      border-color:#e5e7eb; box-shadow:none; cursor:default;
    }
    .week-pill.zero:hover { filter: none; }

    .week-pill.disabled {
      background: #eef2f7;
      color: #6b7280;
      cursor: default;
      box-shadow: none;
    }

    /* ===== Week view ===== */
    .week-wrap { border: 1px solid #e0e0e0; border-radius: 12px; padding: 14px; margin-top: 12px; background: #fff; }
    .week-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .week-title { font-weight: 900; font-size: 22px; }
    .nav-btn { padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; }

    .grid { border: 1px solid #eee; border-radius: 12px; overflow: hidden; margin-top: 10px; }
    .grid-header { display: grid; grid-template-columns: repeat(7, 1fr); }
    .grid-header div { text-align: center; font-size: 12px; padding: 6px 0; background: #fafafa; border-bottom: 1px solid #eee; font-weight: 700; }

    .days { display: grid; grid-template-columns: repeat(7, 1fr); }
    .day { border-right: 1px solid #f2f2f2; border-bottom: 1px solid #f2f2f2; position: relative; padding: 6px; min-height: 120px; }
    .day:nth-child(7n) { border-right: none; }
    .day-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px; }
    .day.today .date { color:#0b5bd3; }
    .date { font-size: 12px; font-weight: 700; color: #333; }
    .past .date { color: #a0a0a0; }

    .heat { position:absolute; inset:0; z-index:0; border-radius:0; }

    .day-body { display: grid; grid-template-columns: 1fr; gap: 8px; position: relative; z-index: 1; }
    .pill { border: 1px solid #c7d6e6; background:#f7fbff; border-radius: 10px; padding: 8px 10px; min-height: 30px; display:flex; align-items:center; gap:8px; font-weight:600; font-size: 13px; justify-content: center; }
    .pill .icon { width: 1.1em; text-align:center; opacity:.55; }
    .pill .label { font-variant-numeric: tabular-nums; }
    .pill.selected { background:#0f3b59; color:#fff; border-color:#0f3b59; }
    .pill.selected .icon { opacity:1; }

    .banner { padding: 10px; margin-top: 10px; border: 1px dashed #d0d7e3; border-radius: 10px; text-align: center; color: #445; background: #f7f9ff; }

    /* utility */
    .hide { display: none !important; }

    /* modals */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: #fff; border-radius: 12px; width: min(520px, 92vw); max-height: 80vh; overflow:auto; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .modal header { padding: 12px 16px; border-bottom: 1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
    .modal h3 { margin:0; font-size: 16px; }
    .modal .content { padding: 12px 16px; }
    .sel-list { display: grid; gap: 8px; }
    .sel-item { display:flex; align-items:center; justify-content:space-between; border:1px solid #eee; border-radius:8px; padding:8px 10px; background:#fafafa; }
    .sel-item .when { font-variant-numeric: tabular-nums; }
    .modal footer { padding: 12px 16px; border-top: 1px solid #eee; display:flex; justify-content:flex-end; gap: 8px; }
    .link-btn { background:none; border:none; color:#2a62d6; cursor:pointer; padding:6px 8px; }

    /* loading modal */
    .loading { display:flex; flex-direction:column; align-items:center; gap:10px; padding: 20px; }
    .loading p { margin:0; color:#333; }
    .spinner { width:36px; height:36px; border:3px solid #cfd8ff; border-top-color:#2a62d6; border-radius:50%; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .heat { border-radius: 10px; padding: 10px 12px; border: 1px solid #e5e7eb; margin: 6px 0; }
    .heat-0 { background: #f3f4f6; }           /* 0 / empty */
    .heat-1 { background: #e8f1ff; }
    .heat-2 { background: #d6eaff; }
    .heat-3 { background: #c3e3ff; }
    .heat-4 { background: #b1dcff; }
    .heat-5 { background: #9cd3ff; }           /* most */

    /* Confirm question styling */
    #confirmQuestionWrap { font-size: 13px; color: #666; }
    #confirmQuestionWrap .cq-title { font-weight: 700; margin: 8px 0 6px; }
    #confirmQuestionWrap .cq-row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    #confirmQuestionWrap label { cursor: pointer; }

    /* USED / CLOSED state ‚Äî green success variant */
    .used-wrap { margin-top: 16px; }
    .used-card {
      border: 1px solid #e5e7eb; border-radius: 14px; background:#fff;
      padding: 18px; display:flex; gap:14px; align-items:flex-start;
      box-shadow: 0 2px 10px rgba(0,0,0,.04);
    }
    
    /* Green tick on soft-green square */
    .used-icon {
      display: inline-grid; place-items: center;
      width: 40px; height: 40px;                    /* square */
      border-radius: 10px;
      font-size: 22px; line-height: 1;
      background:#e8f5e9;                           /* light green */
      color:#166534;                                 /* dark green text */
      border:1px solid #b7dfc2;                      /* soft green border */
      padding:0;                                     /* square, not pill */
    }
    
    .used-body { flex:1; }
    .used-title { margin:0 0 6px; font-weight:800; font-size:18px; }
    .used-sub { margin:0; color:#555; font-size:14px; }
    .used-meta { margin-top:8px; font-size:13px; color:#666; }
    
    .used-actions { margin-top:12px; display:flex; gap:10px; align-items:center; }
    
    /* Buttons + chips in matching green */
    .used-btn {
      display:inline-block; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px;
      border:1px solid #b7dfc2; background:#e8f5e9; color:#166534; font-weight:600;
    }
    .used-btn:hover { filter: brightness(0.98); }
    
    .used-chip {
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px;
      font-size:12px; font-weight:700;
      border:1px solid #b7dfc2; background:#e8f5e9; color:#166534;
    }

    /* Landing step cards */
    .landing-steps{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .step-card{
      width:320px;                    /* fixed width */
      min-height:110px;
      border:1px solid #d9d4fb;       /* light lavender border */
      border-radius:12px;
      background:#ede9fe;             /* lavender fill */
      padding:14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      box-shadow:inset 0 -1px 0 rgba(255,255,255,.7);
      transition:transform .06s ease, box-shadow .12s ease, filter .12s ease;
    }
    .step-card:hover{ filter:brightness(1.02); box-shadow:0 2px 10px rgba(0,0,0,.06); }
    .step-card:active{ transform:translateY(1px); }
    .step-card h3{ margin:0 0 6px; font-size:18px; font-weight:800; }
    .step-card p { margin:0; font-size:14px; color:#374151; }
    
    /* step-card state variants + subtle link */
    .step-card.active  { cursor: pointer; opacity: 1; }
    .step-card.locked  { cursor: default; opacity: .98; }
    .step-card.inactive{
      background:#f3f4f6; border-color:#e5e7eb; color:#6b7280;
      cursor: default; box-shadow:none;
    }
    .step-subtle{
      margin-top:6px; font-size:12px; text-decoration:underline;
      cursor:pointer; opacity:.85;
    }
    /* Booked/confirmed look for Step 1 */
    .step-card.booked{
      background:#e8f5e9;           /* soft green */
      border-color:#b7dfc2;
    }
    .step-card.booked h3,
    .step-card.booked p{
      color:#166534;                 /* deep green text */
    }
    .step-card.booked:hover{ filter:brightness(0.98); }

    .inline-controls{ display:flex; gap:8px; align-items:center; margin:8px 0 4px; }
    .inline-controls .btn{ background:#fff; }
    .inline-title{ font-weight:800; margin:0 0 6px; }

    .inline-controls{ display:flex; gap:8px; align-items:center; margin:12px 0 4px; justify-content:center; }
    .inline-title{ font-weight:800; margin:12px 0 6px; }

    /* Step 2 ‚Äî Agenda look & feel (wider, minimalist rows) */
    #step2 .agenda-wrap{ max-width:652px; }
    #step2 .agenda-title{ font-weight:800; margin:12px 0 6px; }
    #step2 .agenda-list{ display:grid; }
    #step2 .agenda-input-row{ display:flex; gap:8px; margin-top:8px; max-width:652px; }
    #step2 .agenda-input-row input[type="text"]{ flex:1; }
    
    /* Minimal rows (override the generic .sel-item box style) */
    #step2 .agenda-wrap .sel-item{
      background: transparent;
      border: none;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    #step2 .agenda-wrap .sel-item:last-child{ border-bottom: none; }
    #step2 .agenda-wrap .agenda-text{ font-weight:600; }
    #step2 .agenda-wrap .agenda-actions{ display:flex; gap:6px; flex-shrink:0; opacity:.7; }
    #step2 .agenda-wrap .sel-item:hover .agenda-actions{ opacity:1; }
    #step2 .agenda-wrap .sel-item input[type="text"]{ width:100%; min-width:0; }

    .save-status{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:#6b7280; /* slate-500 */
    }
    #s2SaveBtn { padding: 0 6px; }  /* keep it small */

    /* Step 2: put the save UI right after the title text */
    #step2 .week-head{
      justify-content: flex-start;   /* not space-between */
      align-items: baseline;         /* baseline-align with the title */
      gap: 10px;                     /* small gap between title and save UI */
      flex-wrap: wrap;               /* wrap on small screens */
    }
    #step2 .save-status{
      margin-left: 0;                /* remove the right-push */
    }

    /* Step 2 ‚Äì Prep questions card */
    .prep-card{
      border: 1px solid #e5e7eb;          /* hairline */
      border-radius: 12px;                 /* rounded */
      background: #f9fafb;                 /* very light */
      padding: 14px 16px;
    }
    .prep-card .cq-title{ font-weight: 700; margin: 6px 0 8px; }
    .prep-card .cq-row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .prep-banner{font-weight:700}
    .prep-hint{margin-top:4px;color:#666;font-size:13px}
    
    /* nice spacing before the agenda */
    .prep-card + .agenda-wrap{ margin-top:16px; }

  </style>
</head>
<body>

  <!-- Loading modal -->
  <div class="modal-backdrop" id="loadingModal" style="display:flex;">
    <div class="modal">
      <div class="loading">
        <div class="spinner" aria-hidden="true"></div>
        <p aria-live="polite" id="loadingMsg">Fetching availability‚Ä¶</p>
      </div>
    </div>
  </div>

  <div id="app" inert aria-hidden="true">
  
  <h1 class="hide">Pick meeting times</h1>

  <div class="controls hide">
    <div class="tabs">
      <div class="tab active" id="tabOverview">Overview</div>
      <div class="tab" id="tabWeek">Week</div>
    </div>

    <label for="tz">Timezone:</label>
    <select id="tz"></select>
  </div>

  <div class="notice" id="notice">
    Pick up a week, and we‚Äôll search 
    <span id="colleagueName"></span>‚Äôs calendar for availability - including enough time for their preparation.
  </div>

  <div class="breadcrumb hide" id="crumb"></div>

  <!-- LANDING -->
  <div id="landingView">
    <div class="week-wrap">
      <div class="week-head">
        <div class="week-title">Book a session with <span id="landingColleague"></span></div>
      </div>
  
      <div class="landing-steps">
        <div class="step-card" id="step1Card">
          <h3>Step 1</h3>
          <p>Pick a time that works for you.</p>
        </div>
        <div class="step-card" id="step2Card">
          <h3>Step 2</h3>
          <p>Share some details below so we can prepare.</p>
        </div>
      </div>
      <div id="landingInline" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div id="overviewView">
    <div class="ov-grid" id="ovGrid"></div>
  </div>

  <!-- WEEK -->
  <div id="weekView" class="hide">
    <div class="week-wrap">
      <div class="week-head">
        <button class="nav-btn" id="prevWeek">‚Üê</button>
        <div class="week-title" id="weekTitle"></div>
        <button class="nav-btn" id="nextWeek">‚Üí</button>
      </div>

      <div class="grid">
        <div class="grid-header">
          <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div class="days" id="weekDays"></div>
      </div>

      <div class="banner hide" id="emptyWeekBanner">No availability this week.</div>
      <div class="notice" id="weekMeta"></div>
    </div>
  </div>

<!-- STEP 2 PANEL -->
<div id="step2" class="hide">
  <div class="week-wrap">
    <div class="week-head">
      <div class="week-title">
        Step 2: Help <span id="s2Colleague"></span> prepare
      </div>

      <!-- compact save status / action (right side) -->
      <div class="save-status" id="s2SaveUI">
        <span id="s2LastSaved">Not saved yet</span>
        <button class="link-btn" id="s2SaveBtn" style="display:none;">
          Save recent changes üíæ
        </button>
      </div>
    </div>

    <!-- subheading + required hint sit under the header -->
    <div class="notice" id="s2Sub" style="display:none;margin-top:6px;"></div>
    <div id="s2ReqHint" class="notice" style="display:none;margin-top:6px;"></div>

    <!-- questions/agenda mount point -->
    <div id="s2Questions" class="notice" style="margin-top:12px;"></div>
  </div>
</div>



  <!-- CONFIRM MODAL (single-select flow) -->
  <div class="modal-backdrop" id="confirmModal">
    <div class="modal">
      <header>
        <h3>Confirm time</h3>
        <button class="link-btn" id="closeConfirm">Close</button>
      </header>
      <div class="content">
        <p id="confirmWhen" class="notice"></p>
        <p id="confirmPrep" class="notice" style="display:none"></p>
        <div id="inviteList"></div>
        <button class="link-btn" id="addInviteBtn">+ Add another</button>
        <input type="email" id="newInviteInput" class="hide" placeholder="Enter email" />
        <div id="confirmQuestionWrap" class="hide" style="margin-top:12px;"></div>
      </div>
      <footer>
        <button class="btn" id="confirmBtn">Confirm</button>
      </footer>
    </div>
  </div>

  </div>

<script>
  /**********************
   * CONFIG
   **********************/
  // TODO: replace with your deployed Apps Script Web App URL (ends with /exec)
  const API_BASE = 'https://script.google.com/macros/s/AKfycbwqqw_6MRAR9zkkDg6-vUNNETC1UQpS0sdIF6iSh-zT29FbKOcZkkkN-x3aqkvdyI7f8A/exec';

  // Token comes from URL: https://.../index.html?token=abc123
  const token = (new URLSearchParams(location.search).get('token') || '').trim();

  /**********************
   * Small helpers
   **********************/
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  function goToOverview(){
    showOnly('overview');
    setBreadcrumbForOverview();
    renderOverview();
  }


  async function apiGet(action, params) {
    const qs = new URLSearchParams({ action, ...(params || {}) });
    qs.set('ts', Date.now()); // cache buster
    const res = await fetch(`${API_BASE}?${qs.toString()}`, {
      credentials: 'omit',
      cache: 'no-store'
    });
    if (!res.ok) throw new Error(`GET ${action} failed: ${res.status}`);
    return res.json();
  }
  
  async function apiPost(action, params, body) {
    const qs = new URLSearchParams({ action, ...(params || {}) });
    qs.set('ts', Date.now()); // cache buster
    const res = await fetch(`${API_BASE}?${qs}`, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(body || {}),
      credentials: 'omit',
      cache: 'no-store'
    });
    const data = await res.json();
    if (data && data.error) throw new Error(data.error);
    return data;
  }


  function buildMonthWeeksFromWeekList(weeks) {
    // weeks: [{ mondayKey, startISO, weekNum, selectable }]
    const monthWeeks = new Map();
    (weeks || []).forEach(w => {
      const startISO = String(w.startISO);
      const ym = startISO.slice(0, 7); // "YYYY-MM"
      if (!monthWeeks.has(ym)) monthWeeks.set(ym, []);
      monthWeeks.get(ym).push({
        week: w.mondayKey ? `W${String(w.weekNum).padStart(2,'0')}` : `W${w.weekNum}`,
        weekNum: Number(w.weekNum),
        startISO,
        selectable: !!w.selectable
      });
    });
    for (const arr of monthWeeks.values()) {
      arr.sort((a,b) => a.startISO.localeCompare(b.startISO));
    }
    return monthWeeks;
  }

  async function saveInviteesOnce({ suggestedInvitees, preselectedCustomerEmails, reason }) {
    try {
      // Persist suggested list
      await apiPost('saveSuggestedInvitees', { token }, {
        emails: Array.isArray(suggestedInvitees) ? suggestedInvitees : []
      });
  
      // Persist the ‚Äúchecked‚Äù/preselected list
      await apiPost('saveCustomerEmails', { token }, {
        emails: Array.isArray(preselectedCustomerEmails) ? preselectedCustomerEmails : []
      });
  
      // (Optional) you can log reason somewhere client-side if you like
      // console.debug('Invitees saved:', { reason });
    } catch (e) {
      console.error('saveInvitees failed:', e);
    }
  }


  // Put this near your other helpers (top of <script>)
  const coerceCqs = (v) => {
    if (!v) return [];
    if (Array.isArray(v)) return v;
    if (typeof v === 'string') {
      try { const j = JSON.parse(v); return Array.isArray(j) ? j : []; } catch {}
    }
    return [];
  };

  function escapeHtml(s='') {
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

// ‚¨áÔ∏è put near other date helpers
function quarterStartMondayKey(tz){
  const parts = fmtParts(new Date(), tz);
  const y = +parts.find(p=>p.type==='year').value;
  const m = +parts.find(p=>p.type==='month').value;          // 1..12 in user's tz
  const qStartMonth = Math.floor((m-1)/3)*3 + 1;             // 1,4,7,10
  const firstKey = `${y}-${String(qStartMonth).padStart(2,'0')}-01`;
  return mondayKey(firstKey);
}

// Build weeks for the *current* quarter (shows past weeks as .disabled)
function generateWeeksForCurrentQuarter({
  initialTz = 'UTC',
  minNoticeDays = 0,
  weekdaysCSV = 'Mon,Tue,Wed,Thu,Fri',
  blackoutDatesCSV = ''
} = {}) {
  const startMon = quarterStartMondayKey(initialTz);

  // first day *after* the quarter
  const parts = fmtParts(new Date(), initialTz);
  const y = +parts.find(p=>p.type==='year').value;
  const m = +parts.find(p=>p.type==='month').value;
  const qStartMonthIdx = Math.floor((m-1)/3)*3;              // 0,3,6,9
  const after = new Date(Date.UTC(y, qStartMonthIdx + 3, 1)); // month after quarter
  const afterKey = `${after.getUTCFullYear()}-${String(after.getUTCMonth()+1).padStart(2,'0')}-01`;
  const afterMon = mondayKey(afterKey);

  const allowedWeekdays = parseAllowedWeekdays(weekdaysCSV);
  const blackouts = new Set(
    String(blackoutDatesCSV||'').split(/[,\s]+/).map(s=>s.trim()).filter(s=>/^\d{4}-\d{2}-\d{2}$/.test(s))
  );
  const today = todayKey(initialTz);
  const minStartKey = plusDaysKey(today, minNoticeDays);

  const out = [];
  for (let wk = startMon; wk < afterMon; wk = plusDaysKey(wk, 7)) {
    const days = weekDaysFromMondayKey(wk);
    // selectable only if any allowed day is on/after minStart and not blacked out
    const selectable = days.some(d =>
      d >= minStartKey &&
      !blackouts.has(d) &&
      allowedWeekdays.has(dayOfWeekFromKey(d))
    );
    out.push({
      startISO: new Date(wk + 'T00:00:00Z').toISOString(),
      weekNum:  isoWeekNumberFromKey(wk),
      selectable
    });
  }
  return out;
}

  
  /**********************
   * Debounced server writes
   **********************/
  function makeDebounce(fn, wait=400){
    let t, lastArgs;
    const call = (...args) => { lastArgs=args; clearTimeout(t); t=setTimeout(()=>{fn(...lastArgs); t=null;}, wait); };
    call.flush = () => { if (t){ clearTimeout(t); fn(...(lastArgs||[])); t=null; } };
    return call;
  }

  const saveConfirmAnswerDebounced = debounce((key, value) => {
    if (!key) return;
    apiPost('saveConfirmAnswer', { token }, { key, value }).catch(console.error);
  }, 400);

  /**********************
   * State & DOM refs
   **********************/
  let initialTz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  let timezones = ['UTC', 'Europe/Berlin', 'Europe/London', 'America/New_York', 'America/Chicago', 'America/Los_Angeles', 'Australia/Sydney'];
  let MAX_SELECT = 1;

  const state = {
    tz: initialTz,
    dayCounts: new Map(),
    weekTotals: new Map(),
    monthWeeks: new Map(),
    currentWeek: null,
    weekCache: new Map(),
    suggestedInvitees: [],
    preselectedCustomerEmails: [],
    confirmQuestions: [],    
    stage: 'overview',
    lastBooked: null,   // {start: Date, end: Date}
    lastPrep: null      // {start: Date, end: Date} | null
  };

  // Shared working state for the confirm modal, accessible to close/backdrop handlers
  const confirmDraft = {
    candidates: [],           // [{ email, _userAdded?, _preselected?, _suggested? }]
    selected: new Set(),      // lowercased emails that are checked
    dirty: false
  };
  
  function collectInviteesForSave() {
    return {
      suggestedInvitees: confirmDraft.candidates.map(c => String(c.email).trim()),
      preselectedCustomerEmails: Array.from(confirmDraft.selected).map(x => String(x).trim())
    };
  }

  let pendingWeekKey = null;

  const tzSel = document.getElementById('tz');
  const crumb = document.getElementById('crumb');
  const tabOverview = document.getElementById('tabOverview');
  const tabWeek = document.getElementById('tabWeek');
  const overviewView = document.getElementById('overviewView');
  const ovGrid = document.getElementById('ovGrid');
  const weekView = document.getElementById('weekView');
  const weekTitleEl = document.getElementById('weekTitle');
  const weekDaysEl = document.getElementById('weekDays');
  const prevWeekBtn = document.getElementById('prevWeek');
  const nextWeekBtn = document.getElementById('nextWeek');
  const weekMetaEl = document.getElementById('weekMeta');
  const emptyWeekBanner = document.getElementById('emptyWeekBanner');
  const loadingModal = document.getElementById('loadingModal');
  const loadingMsg = document.getElementById('loadingMsg');
  const confirmModal = document.getElementById('confirmModal');
  const confirmWhen = document.getElementById('confirmWhen');
  let confirmBtn = document.getElementById('confirmBtn');
  const closeConfirm = document.getElementById('closeConfirm');
  const colleagueNameEl = document.getElementById('colleagueName');
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && confirmModal.style.display === 'flex') {
      closeConfirmModal(true); // also clears pending pill
    }
  });

  // Backdrop click: save if dirty, then close
  confirmModal.addEventListener('click', async (e) => {
    if (e.target === confirmModal) {
      if (confirmDraft.dirty) {
        const { suggestedInvitees, preselectedCustomerEmails } = collectInviteesForSave();
        await saveInviteesOnce({ suggestedInvitees, preselectedCustomerEmails, reason: 'dismiss' });
        confirmDraft.dirty = false;
      }
      closeConfirmModal(true);
    }
  });


  let pendingIso = null;
  let pendingPill = null;

  /**********************
   * Utilities (unchanged)
   **********************/
  function fmtParts(date, tz) { return new Intl.DateTimeFormat('en-GB', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(date); }
  function ymdKey(date, tz) { const p = fmtParts(date, tz); return `${p.find(x => x.type === 'year').value}-${p.find(x => x.type === 'month').value}-${p.find(x => x.type === 'day').value}`; }
  function monthTitle(y, m) { return new Date(Date.UTC(y, m - 1, 1)).toLocaleString('en-GB', { month: 'long', year: 'numeric' }); }
  function mondayKey(key) { const d = new Date(key + 'T00:00:00Z'); const js = d.getUTCDay(); const delta = js === 0 ? -6 : 1 - js; d.setUTCDate(d.getUTCDate() + delta); return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`; }
  function plusDaysKey(key, n) { const d = new Date(key + 'T00:00:00Z'); d.setUTCDate(d.getUTCDate() + n); return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`; }
  function tzTimeHM(date, tz) { const s = new Intl.DateTimeFormat('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false }).format(date); return s.replace(':', 'h'); }
  function todayKey(tz) { return ymdKey(new Date(), tz); }
  function isoWeekNumberFromKey(dayKey) { const d = new Date(dayKey + 'T00:00:00Z'); const day = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - day); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
  function weekDaysFromMondayKey(monKey) { return Array.from({ length: 7 }, (_, i) => plusDaysKey(monKey, i)); }
  function parseSlots(raw) {
    return (raw || [])
      .map(s => ({
        start: new Date(s.start),
        end:   new Date(s.end),
        // keep the server‚Äôs chosen prep block (if any)
        prep:  (s.prep && s.prep.start && s.prep.end)
          ? { start: new Date(s.prep.start), end: new Date(s.prep.end) }
          : null
      }))
      .filter(s => !isNaN(s.start) && !isNaN(s.end));
  }

  function makeQuantileBuckets(counts) { const arr = counts.filter(n => Number.isFinite(n)).slice().sort((a, b) => a - b); if (!arr.length) return [0, 0, 0, 0, 0]; const q = p => arr[Math.min(arr.length - 1, Math.floor(p * (arr.length - 1)))]; return [q(0.2), q(0.4), q(0.6), q(0.8), arr[arr.length - 1]]; }
  function heatLevel(count, breaks) { if (count <= 0) return 0; const [q1, q2, q3, q4, _max] = breaks; if (count <= q1) return 1; if (count <= q2) return 2; if (count <= q3) return 3; if (count <= q4) return 4; return 5; }
  function weekLabel(monKey) { const d = new Date(monKey + 'T00:00:00Z'); const mon = d.toLocaleString('en-GB', { month: 'short' }); return `Week of ${mon} ${d.getUTCDate()}${ordinal(d.getUTCDate())} ‚Äî Wk ${isoWeekNumberFromKey(monKey)}`; }
  function weekColorForValue(value, max) { if (!value || !max) return null; const gamma = 0.75; let t = Math.max(0, Math.min(1, value / max)); t = Math.pow(t, gamma); const palette = ['#faf5ff', '#f3e8ff', '#e9d5ff', '#d8b4fe', '#c084fc', '#a855f7', '#9333ea', '#7e22ce', '#6b21a8']; const idx = Math.min(palette.length - 1, Math.round(t * (palette.length - 1))); return palette[idx]; }
  function needsLightText(hex) { if (!hex) return false; const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); if (!m) return false; const r = parseInt(m[1], 16) / 255, g = parseInt(m[2], 16) / 255, b = parseInt(m[3], 16) / 255; const c = [r, g, b].map(x => x <= 0.03928 ? x / 12.92 : Math.pow((x + 0.055) / 1.055, 2.4)); const L = 0.2126 * c[0] + 0.7152 * c[1] + 0.0722 * c[2]; return L < 0.58; }
  function ordinal(n) { const mod10 = n % 10, mod100 = n % 100; if (mod100 >= 11 && mod100 <= 13) return 'th'; switch (mod10) { case 1: return 'st'; case 2: return 'nd'; case 3: return 'rd'; default: return 'th'; } }
  function formatWeekLabel(startISO) { const d = new Date(startISO); const month = d.toLocaleString('en-US', { month: 'long', timeZone: 'UTC' }); const day = d.getUTCDate(); return `Week of ${month} ${day}${ordinal(day)}`; }
  function isoWeekMonday(y, w) { const jan4 = new Date(Date.UTC(y, 0, 4)); const day = jan4.getUTCDay() || 7; const monW1 = new Date(jan4); monW1.setUTCDate(jan4.getUTCDate() - day + 1); const d = new Date(monW1); d.setUTCDate(monW1.getUTCDate() + (w - 1) * 7); return d; }

  function groupWeeksFromObject(weeksObj) {
    const weekTotals = new Map();
    const monthWeeks = new Map();
    for (const [rawKey, rawCnt] of Object.entries(weeksObj || {})) {
      const m = String(rawKey).trim().match(/^(\d{4})-W(\d{1,2})$/);
      if (!m) continue;
      const y = +m[1], w = +m[2];
      const wkKey = `${y}-W${String(w).padStart(2, '0')}`;
      const count = Number(rawCnt) || 0;
      weekTotals.set(wkKey, count);
      const mon = isoWeekMonday(y, w);
      if (isNaN(+mon)) continue;
      const startISO = mon.toISOString();
      const monthKey = startISO.slice(0, 7);
      if (!monthWeeks.has(monthKey)) monthWeeks.set(monthKey, []);
      monthWeeks.get(monthKey).push({ week: wkKey, weekNum: w, startISO, count });
    }
    for (const arr of monthWeeks.values()) arr.sort((a, b) => a.startISO.localeCompare(b.startISO));
    return { weekTotals, monthWeeks };
  }
    function fmtDateLocal(d, tz) {
      return new Intl.DateTimeFormat('en-GB', {
        timeZone: tz, weekday:'short', year:'numeric', month:'short', day:'numeric'
      }).format(d);
    }
    function fmtTimeLocal(d, tz) {
      return new Intl.DateTimeFormat('en-GB', {
        timeZone: tz, hour:'2-digit', minute:'2-digit', hour12:false
      }).format(d).replace(':','h');
    }
    function fmtRangeLocal(s, e, tz) { return `${fmtTimeLocal(s, tz)}‚Äì${fmtTimeLocal(e, tz)}`; }
 
    // track what was booked (handy if you reference later)
    state.stage = 'overview';
    state.lastBooked = null;   // {start: Date, end: Date}
    state.lastPrep   = null;   // {start: Date, end: Date} | null

  /**********************
   * View toggles + loading UI
   **********************/
  function setTabs(active) {
    [tabOverview, tabWeek].forEach(t => t.classList.remove('active'));
    ({ overview: tabOverview, week: tabWeek }[active]).classList.add('active');
  }
  function showOnly(view) {
    const onLanding = view === 'landing';
    document.querySelector('h1')?.classList.toggle('hide', onLanding); // <-- Add this line
    document.querySelector('.controls')?.classList.toggle('hide', onLanding);
    document.getElementById('notice')?.classList.toggle('hide', onLanding);
    document.getElementById('crumb')?.classList.toggle('hide', onLanding);
    
    landingView.classList.toggle('hide', !onLanding);
    overviewView.classList.toggle('hide', view !== 'overview');
    weekView.classList.toggle('hide', view !== 'week');
    
    // Keep tab styling sane when landing is shown
    setTabs(view === 'week' ? 'week' : 'overview');
  }
  
  const landingView = document.getElementById('landingView');
  function setBreadcrumbForLanding(){ crumb.textContent = 'Welcome'; }
  function setBreadcrumbForOverview() { crumb.textContent = 'View: Overview'; }
  function setBreadcrumbForWeek(monKey) {
    const d = new Date(monKey + 'T00:00:00Z');
    const label = `${d.toLocaleString('en-GB', { month: 'long', year: 'numeric' })} ‚Ä¢ Week ${isoWeekNumberFromKey(monKey)}`;
    crumb.innerHTML = `View: <a onclick="renderOverview()">Overview</a> / ${label}`;
  }
  function showLoading(msg) { if (msg) loadingMsg.textContent = msg; loadingModal.style.display = 'flex'; }
  function hideLoading() { loadingModal.style.display = 'none'; loadingMsg.textContent = 'Fetching availability‚Ä¶'; }

  /**********************
   * Overview rendering
   **********************/
  function renderOverview() {
    showOnly('overview');
    setBreadcrumbForOverview();
  
    ovGrid.innerHTML = '';
    if (!state?.monthWeeks || state.monthWeeks.size === 0) {
      const empty = document.createElement('div');
      empty.className = 'notice';
      empty.textContent = 'No weeks available in the current window.';
      ovGrid.appendChild(empty);
      return;
    }

    console.log('üü™ Rendering overview weeks:', [...state.monthWeeks.entries()]);
  
    const months = [...state.monthWeeks.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    months.forEach(([ym, weeks]) => {
      const [y, m] = ym.split('-').map(Number);
  
      const card = document.createElement('div'); card.className = 'mcard';
      const head = document.createElement('div'); head.className = 'mhead';
      const name = document.createElement('div'); name.className = 'mname'; name.textContent = monthTitle(y, m);
      head.appendChild(name); card.appendChild(head);
  
      const list = document.createElement('div'); list.className = 'weeks';
  
      weeks.forEach(w => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'week-pill';
        btn.textContent = `${formatWeekLabel(w.startISO)} ‚Äî Wk ${w.weekNum}`;
  
        const monKey = w.startISO.slice(0,10);
        if (!w.selectable) {
          // too soon (within minNoticeDays): show muted & disabled
          btn.classList.add('disabled');
          btn.disabled = true;
        } else {
          btn.addEventListener('click', () => openWeek(monKey));
        }
        list.appendChild(btn);
      });
  
      card.appendChild(list);
      ovGrid.appendChild(card);
    });
  
    hideLoading();
  }

  function renderUsedState(meta) {
    // Hide interactive UI
    document.querySelector('.controls')?.classList.add('hide');
    document.getElementById('overviewView')?.classList.add('hide');
    document.getElementById('weekView')?.classList.add('hide');
  
    // Title
    const h1 = document.querySelector('h1');
    if (h1) h1.textContent = 'Booking confirmed!';
  
    // Remove the small notice bar
    document.getElementById('notice')?.classList.add('hide');
  
    // Card
    const wrap = document.createElement('div');
    wrap.className = 'used-wrap';
  
    const card = document.createElement('div');
    card.className = 'used-card';
  
    const icon = document.createElement('div');
    icon.className = 'used-icon';
    icon.textContent = 'üóìÔ∏è';
  
    const body = document.createElement('div');
    body.className = 'used-body';
  
    const title = document.createElement('h2');
    title.className = 'used-title';
    title.textContent = 'We are looking forward to the session';
  
    const sub = document.createElement('p');
    sub.className = 'used-sub';
    sub.textContent = 'Thanks for booking. If you need to reschedule, we can help.';
  
    // Who / type line
    const metaLine = document.createElement('div');
    metaLine.className = 'used-meta';
    const who = meta?.colleagueInitials ? ` with ${meta.colleagueInitials}` : '';
    const mt  = meta?.meetingType ? ` ‚Äî ${meta.meetingType}` : '';
    metaLine.textContent = `Status: ${meta?.status || 'USED'}${who}${mt}`;
  
    // NEW: booked time line
    const tz = meta?.initialTz || 'UTC';
    const fmt = new Intl.DateTimeFormat('en-GB', {
      timeZone: tz, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit', hour12: false
    });
  
    const bookedLine = document.createElement('div');
    bookedLine.className = 'used-meta';
    if (meta?.bookedStartISO) {
      const d = new Date(meta.bookedStartISO);
      if (!isNaN(+d)) bookedLine.textContent = `Meeting time: ${fmt.format(d)}`;
    } else if (meta?.bookedAtISO) {
      const d = new Date(meta.bookedAtISO);
      if (!isNaN(+d)) bookedLine.textContent = `Booked on: ${fmt.format(d)}`;
    }
  
    // NEW: colleague email line + action
    const emailLine = document.createElement('div');
    emailLine.className = 'used-meta';
    if (meta?.colleagueEmail) {
      const a = document.createElement('a');
      a.href = `mailto:${encodeURIComponent(meta.colleagueEmail)}?subject=Reschedule%20my%20meeting`;
      a.textContent = meta.colleagueEmail;
      emailLine.textContent = 'Contact: ';
      emailLine.appendChild(a);
    }
  
    const actions = document.createElement('div');
    actions.className = 'used-actions';
  
    const usedChip = document.createElement('span');
    usedChip.className = 'used-chip';
    usedChip.textContent = 'USED';
    actions.appendChild(usedChip);
  
    if (meta?.allowRebook) {
      const info = document.createElement('span');
      info.className = 'used-sub';
      info.textContent = 'Rebooking is enabled for this link.';
      actions.appendChild(info);
    }
  
    body.append(title, sub, metaLine);
    if (bookedLine.textContent) body.append(bookedLine);
    if (emailLine.textContent) body.append(emailLine);
    body.append(actions);
  
    card.append(icon, body);
    wrap.append(card);
  
    const afterH1 = document.querySelector('h1');
    if (afterH1 && afterH1.parentNode) {
      afterH1.parentNode.insertBefore(wrap, afterH1.nextSibling);
    } else {
      document.body.prepend(wrap);
    }
    refreshLandingCards({ metaOverride: meta });
  }

  /**********************
   * Week data & rendering (fetch via API)
   **********************/
  function ensureWeekLoaded(mondayKey, { prefetch=false } = {}) {
    if (state.weekCache.has(mondayKey)) return Promise.resolve(state.weekCache.get(mondayKey));
    pendingWeekKey = mondayKey;
    return loadWeekCoarseToFine(mondayKey, { prefetch })
      .then(payload => {
        if (!prefetch && state.currentWeek === mondayKey && pendingWeekKey === mondayKey) {
          renderWeek(payload);
        }
        return payload;
      })
      .catch(err => {
        if (!prefetch) alert('Failed to load week.\n' + (err && err.message ? err.message : String(err)));
        throw err;
      })
      .finally(() => { if (pendingWeekKey === mondayKey) pendingWeekKey = null; });
  }

  function openWeek(mondayKey) {
    state.currentWeek = mondayKey;
    showOnly('week');
    setBreadcrumbForWeek(mondayKey);
    setWeekHeader(mondayKey);
    showLoading('Loading this week‚Ä¶');
  
    ensureWeekLoaded(mondayKey).then(() => {
      if (state.currentWeek === mondayKey) prefetchNeighbors(mondayKey);
    });
  }

  function setWeekHeader(mondayKey) {
    const d = new Date(mondayKey + 'T00:00:00Z');
    weekTitleEl.textContent = `${d.toLocaleString('en-GB', { month: 'long', year: 'numeric' })} ‚Ä¢ Week ${isoWeekNumberFromKey(mondayKey)}`;
  }

  function prefetchNeighbors(mondayKey) {
    const next = plusDaysKey(mondayKey, 7);
    const prev = plusDaysKey(mondayKey, -7);
    // For prefetch, do the 60-min pass only (fast & light)
    fetchWeekAtGranularity(next, 60).then(r => {
      state.weekCache.set(next, { slotsParsed: r.parsed, exactCount: r.count });
    }).catch(()=>{});
    fetchWeekAtGranularity(prev, 60).then(r => {
      state.weekCache.set(prev, { slotsParsed: r.parsed, exactCount: r.count });
    }).catch(()=>{});
  }

function renderWeek(payload) {
  setWeekHeader(state.currentWeek);

  const days = weekDaysFromMondayKey(state.currentWeek);
  const today = todayKey(state.tz);
  const byDay = new Map(days.map(k => [k, []]));
  payload.slotsParsed.forEach(s => {
    const key = ymdKey(s.start, state.tz);
    if (byDay.has(key)) byDay.get(key).push(s);
  });
  days.forEach(k => byDay.get(k).sort((a, b) => a.start - b.start));

  weekDaysEl.innerHTML = '';
  days.forEach(dayKey => {
    const inPast = dayKey < today;
    const dNum = Number(dayKey.slice(-2));
    const col = document.createElement('div');
    col.className = 'day' + (inPast ? ' past' : '');
    const header = document.createElement('div'); header.className = 'day-header';
    const dateEl = document.createElement('div'); dateEl.className = 'date'; dateEl.textContent = dNum;
    header.appendChild(dateEl); col.appendChild(header);

    const body = document.createElement('div'); body.className = 'day-body';
    const items = byDay.get(dayKey) || [];
    items.forEach(slot => {
      const iso = slot.start.toISOString();
      const pill = document.createElement('button');
      pill.type = 'button';
      pill.className = 'pill';

      const icon = document.createElement('span'); icon.className = 'icon'; icon.textContent = '‚óã';
      const label = document.createElement('span'); label.className = 'label';
      label.textContent = `${tzTimeHM(slot.start, state.tz)} ‚Äì ${tzTimeHM(slot.end, state.tz)}`;
      pill.append(icon, label);

      pill.onclick = () => {
        // single-select: visually mark the current one
        document.querySelectorAll('.pill.selected').forEach(el => {
          if (el !== pill) {
            el.classList.remove('selected');
            const ic = el.querySelector('.icon'); if (ic) ic.textContent = '‚óã';
          }
        });
        pill.classList.add('selected'); icon.textContent = '‚úì';
        pendingIso = iso;
        pendingPill = pill;
        openConfirmModal(iso, slot);
      };

      body.appendChild(pill);
    });

    col.appendChild(body);
    weekDaysEl.appendChild(col);
  });

  emptyWeekBanner.classList.toggle('hide', (payload.exactCount || 0) > 0);
  weekMetaEl.textContent = `Found ${payload.exactCount || 0} slot${(payload.exactCount || 0) === 1 ? '' : 's'}.`;
  hideLoading();
}


  /**********************
   * Confirm modal
   **********************/
  function parseOptionsLoose(raw) {
    if (Array.isArray(raw)) {
      if (raw.length === 1 && /^\s*\[/.test(raw[0])) { try { const j = JSON.parse(raw[0]); if (Array.isArray(j)) return j; } catch { } }
      return raw.map(String);
    }
    if (typeof raw === 'string') {
      const s = raw.trim();
      if (s.startsWith('[') && s.endsWith(']')) { try { const j = JSON.parse(s); if (Array.isArray(j)) return j; } catch { } }
      return s.split(/[\n,;|]/).map(x => x.trim()).filter(Boolean);
    }
    return [];
  }
  function cleanLabel(s) {
    return String(s).replace(/^\s*\[/, '').replace(/\]\s*$/, '').replace(/^["']|["']$/g, '').replace(/''/g, "'");
  }

  function openConfirmModal(iso, slot) {
    // Re-grab the current button node from the DOM
    confirmBtn = document.getElementById('confirmBtn');
  
    const inviteListEl = document.getElementById('inviteList');
    const addInviteBtn = document.getElementById('addInviteBtn');
    const newInviteInp = document.getElementById('newInviteInput');
    const qWrap = document.getElementById('confirmQuestionWrap');
    qWrap.innerHTML = '';
    qWrap.classList.add('hide');

    const norm = s => String(s || '').trim();
    const lower = s => norm(s).toLowerCase();
    const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(norm(s));

    const suggested = (state.suggestedInvitees || [])
      .map(norm)
      .filter(isEmail);
    
    const preselected = (state.preselectedCustomerEmails || [])
      .map(norm)
      .filter(isEmail);
    
    const suggestedLC   = new Set(suggested.map(lower));
    const preselectedLC = new Set(preselected.map(lower));
    
    // Build candidate list + default selection, then seed the shared draft
    confirmDraft.candidates = Array.from(new Set([...suggested, ...preselected]))
      .map(e => ({
        email: e,
        _userAdded: false,
        _preselected: preselectedLC.has(lower(e)),
        _suggested:  suggestedLC.has(lower(e))
      }));
    
    confirmDraft.selected = new Set(preselected.map(lower)); // only preselected are checked by default
    confirmDraft.dirty = false;

    function renderInviteList() {
      inviteListEl.innerHTML = '';
      const items = confirmDraft.candidates;
    
      if (!items.length) {
        const p = document.createElement('p');
        p.className = 'notice';
        p.textContent = 'Add at least one attendee email to proceed.';
        inviteListEl.appendChild(p);
        validateConfirmEnabled();
        return;
      }
    
      items.forEach((c, idx) => {
        const row = document.createElement('label');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        row.style.margin = '6px 0';
    
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = confirmDraft.selected.has(lower(c.email));
        cb.addEventListener('change', () => {
          const key = lower(c.email);
          if (cb.checked) confirmDraft.selected.add(key);
          else confirmDraft.selected.delete(key);
          confirmDraft.dirty = true;
          validateConfirmEnabled();
        });
    
        const span = document.createElement('span');
        span.textContent = c.email;
    
        const rm = document.createElement('button');
        rm.type = 'button';
        rm.textContent = 'Remove';
        rm.className = 'link-btn';
        rm.style.marginLeft = 'auto';
        rm.addEventListener('click', () => {
          confirmDraft.selected.delete(lower(c.email));
          confirmDraft.candidates.splice(idx, 1);
          confirmDraft.dirty = true;
          renderInviteList();
          validateConfirmEnabled();
        });
    
        if (!c._userAdded) rm.style.display = 'none';
    
        row.append(cb, span, rm);
        inviteListEl.appendChild(row);
      });
    }

    function validateConfirmEnabled() {
      const hasEmails = confirmDraft.selected.size > 0;
      confirmBtn.disabled = !hasEmails;
    }

    function addNewInviteFromInput() {
      const raw = norm(newInviteInp.value);
      const lc = lower(raw);
      if (!raw) return;
      if (!isEmail(raw)) { alert('Please enter a valid email address.'); return; }
      if (confirmDraft.candidates.some(c => lower(c.email) === lc)) { alert('That address is already listed.'); return; }
    
      confirmDraft.candidates.push({ email: raw, _userAdded: true });
      if (confirmDraft.candidates.length > 15) {
        confirmDraft.candidates = confirmDraft.candidates.slice(-15);
      }
      confirmDraft.selected.add(lc);
      confirmDraft.dirty = true;
    
      newInviteInp.value = '';
      renderInviteList();
      validateConfirmEnabled();
    }

    const fmtDate = new Intl.DateTimeFormat('en-GB', { timeZone: state.tz, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
    const fmtTime = new Intl.DateTimeFormat('en-GB', { timeZone: state.tz, hour: '2-digit', minute: '2-digit', hour12: false });
    const dateStr = s => new Intl.DateTimeFormat('en-GB', { timeZone: state.tz, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }).format(s);
    const timeStr = (s, e) => new Intl.DateTimeFormat('en-GB', { timeZone: state.tz, hour: '2-digit', minute: '2-digit', hour12: false }).format(s).replace(':', 'h') + '‚Äì' + new Intl.DateTimeFormat('en-GB', { timeZone: state.tz, hour: '2-digit', minute: '2-digit', hour12: false }).format(e).replace(':', 'h');

    confirmWhen.textContent = ''; // set below when slot passed
    renderInviteList();     
    validateConfirmEnabled();
    confirmWhen.textContent = `${dateStr(slot.start)} ‚Ä¢ ${timeStr(slot.start, slot.end)}`;

    const confirmPrepEl = document.getElementById('confirmPrep');
    confirmPrepEl.style.display = 'none';
    confirmPrepEl.textContent = '';
    
    if (slot && slot.prep && slot.prep.start && slot.prep.end) {
      const ps = slot.prep.start; // Date
      const name =
        state?.meta?.colleagueFirstName ||
        state?.meta?.colleagueEmail ||
        (colleagueNameEl && colleagueNameEl.textContent) ||
        'they';
    
      const startTime = new Intl.DateTimeFormat('en-GB', {
        timeZone: state.tz, hour: '2-digit', minute: '2-digit', hour12: false
      }).format(ps).replace(':', 'h');
    
      confirmPrepEl.textContent =
        `${name} would begin preparing for the call on ${dateStr(ps)} at ${startTime}.`;
      confirmPrepEl.style.display = '';
    }

    addInviteBtn.onclick = () => {
      newInviteInp.classList.toggle('hide');
      if (!newInviteInp.classList.contains('hide')) newInviteInp.focus();
    };
    newInviteInp.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); addNewInviteFromInput(); } };
    newInviteInp.onblur = () => { if (String(newInviteInp.value || '').trim()) addNewInviteFromInput(); };

    confirmBtn.textContent = 'Confirm';
    confirmBtn.classList.remove('success', 'error');

    confirmModal.style.display = 'flex';
    confirmBtn.onclick = async () => {
      if (confirmDraft.selected.size === 0) {
        alert('Please add at least one attendee email.');
        return;
      }
    
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Booking‚Ä¶';
    
      // ‚¨áÔ∏è Show the modal NOW, then yield so it paints.
      showLoading('Booking your time‚Ä¶');
      await nextFrame(); // guarantees the spinner + message are visible
    
      // (Optional but nice) optimistic UI: stamp Step 1 + hide week immediately
      if (!state.meta) state.meta = {};
      refreshLandingCards();
      document.querySelectorAll('#weekView .week-wrap, #landingInline .week-wrap')
        .forEach(el => el.classList.add('hide'));
    
      // Save invitees, but don‚Äôt block the spinner on it
      const { suggestedInvitees, preselectedCustomerEmails } = collectInviteesForSave();
      saveInviteesOnce({ suggestedInvitees, preselectedCustomerEmails, reason: 'confirm' })
        .catch(console.error);
      confirmDraft.dirty = false;
      state.suggestedInvitees = suggestedInvitees.slice();
      state.preselectedCustomerEmails = preselectedCustomerEmails.slice();
    
      const explicitCustomerEmails = Array.from(confirmDraft.selected);
      const preferredPrep =
        (slot && slot.prep)
          ? { start: slot.prep.start.toISOString(), end: slot.prep.end.toISOString() }
          : undefined;
      const extra = {
        explicitCustomerEmails,
        ...(preferredPrep ? { [iso]: preferredPrep } : {})
      };
    
      try {
        const resp = await runBlocking(
          () => apiPost('reserveSlots', { token }, { slots: [iso], extra }),
          { startMsg: 'Booking the session...', slowMsg: 'Booking prep time...', slowAfterMs: 3000, preShown: true }
        );
      
        const c = resp?.confirmed?.[iso];
      
        if (c) {
          // keep local ‚Äúmeta‚Äù in sync so Step 1 card renders from real data
          state.meta.bookedStartISO = c.start;
          state.meta.bookedEndISO   = c.end || (slot ? slot.end.toISOString() : '');
          state.meta.selectedStartsJSON = [c.start];
          state.meta.status = 'USED';
      
          // hydrate the slot used by Step 2 subtitle
          slot.start = new Date(c.start);
          slot.end   = new Date(c.end || slot.end?.toISOString() || c.start);
      
          if (c.prep?.start && c.prep?.end) {
            slot.prep = {
              start: new Date(c.prep.start),
              end:   new Date(c.prep.end)
            };
          }
        }
      
        // Update Step 1 card with real data
        refreshLandingCards();
      
        // Success UI + Step 2 render
        confirmBtn.classList.add('success');
        confirmBtn.textContent = 'Booked!';
        renderStep2FromSlot(slot);
      
        setTimeout(() => {
          confirmModal.style.display = 'none';
          pendingIso = null; pendingPill = null;
        }, 900);
    
      } catch (err) {
        // (optional) revert the optimistic Step 1 if you want
        // e.g., delete state.meta.bookedStartISO; refreshLandingCards();
    
        confirmBtn.classList.add('error');
        confirmBtn.textContent = 'Try again';
        alert(err && err.message ? err.message : String(err));
        confirmBtn.disabled = false;
      }
    };
  }

  function closeConfirmModal(revertIfAny = true) {
    confirmModal.style.display = 'none';
    if (revertIfAny && pendingPill) {
      pendingPill.classList.remove('selected');
      const icon = pendingPill.querySelector('.icon'); if (icon) icon.textContent = '‚óã';
    }
    pendingIso = null; pendingPill = null;
  }
  
  // Close (X) button: save if dirty, then close
  closeConfirm.onclick = async () => {
    if (confirmDraft.dirty) {
      const { suggestedInvitees, preselectedCustomerEmails } = collectInviteesForSave();
      await saveInviteesOnce({ suggestedInvitees, preselectedCustomerEmails, reason: 'close' });
      confirmDraft.dirty = false;
    }
    closeConfirmModal(true);
  };

function renderStep2FromSlot(slot) {
  state.lastBooked = slot ? { start: slot.start, end: slot.end } : null;
  state.lastPrep   = (slot && slot.prep) ? { start: slot.prep.start, end: slot.prep.end } : null;
  state.stage = 'postBook';

  document.getElementById('overviewView')?.classList.add('hide');
  document.getElementById('weekView')?.classList.add('hide');
  document.getElementById('step2')?.classList.remove('hide');

  const s2Colleague = document.getElementById('s2Colleague');
  const s2Sub       = document.getElementById('s2Sub');

  const colleagueName =
    state?.meta?.colleagueFirstName ||
    state?.meta?.colleagueEmail ||
    'your Culture Amp contact';

  if (s2Colleague) s2Colleague.textContent = colleagueName;

  // Build the single prep card (bold line + optional inline hint)
  const hasQs   = Array.isArray(state.confirmQuestions) && state.confirmQuestions.length > 0;
  const hasPrep = !!(slot && slot.prep && slot.prep.start && slot.prep.end);

  if (s2Sub) {
    s2Sub.classList.remove('prep-card');
    s2Sub.style.display = 'none';

    if (hasQs) {
      // Top/bold line
      let top;
      if (hasPrep) {
        const ps = slot.prep.start;
        const startTime = fmtTimeLocal(ps, state.tz).replace(':','h');
        top = `We've held a preparation slot for ${colleagueName} on ${fmtDateLocal(ps, state.tz)} at ${startTime}. ` +
              `Answering the questions below will help them in their preparation.`;
      } else {
        top = `Answering the questions below will help them in their preparation.`;
      }

      // Inline required hint (in brackets), if any
      const missing = missingRequiredCount ? missingRequiredCount() : 0;
      const hint = (missing > 0)
        ? `(${missing === 1 ? '1 required question is unanswered.' : `${missing} required questions are unanswered.`})`
        : '';

      s2Sub.classList.add('prep-card');
      s2Sub.innerHTML = `
        <div class="prep-banner"><strong>${top}</strong></div>
        ${hint ? `<div class="prep-hint">${hint}</div>` : ''}
      `;
      s2Sub.style.display = '';
    }
  }

  renderStep2Questions(slot);
  renderAgenda(slot);

  const saveBtn = document.getElementById('s2SaveBtn');
  if (saveBtn) saveBtn.onclick = () => saveSnapshot();
  updateSaveUI(); // keep this; if you later want live hint updates, you can refresh .prep-hint here.
}

function renderStep2Questions(slot) {
  const mount = document.getElementById('s2QMount') || document.getElementById('s2Questions');
  mount.innerHTML = '';  // clear within the single card

  const prep = slot?.prep || null;
  const ctx = { /* ...as you have it... */ };

  const qs = Array.isArray(state.confirmQuestions) && state.confirmQuestions.length
    ? state.confirmQuestions
    : (state.confirmQuestion ? [state.confirmQuestion] : []);

  if (!qs.length) { updateSaveUI(); return; }

  ensureStateShape();

  // no extra .prep-card wrapper here ‚Äì just blocks
  qs.forEach((cq, idx) => {
    const key = String(cq?.key || (`q${idx}`));
    const block = document.createElement('div');
    block.style.margin = '12px 0';

    const title = document.createElement('div');
    title.className = 'cq-title';
    title.textContent = interp(cq?.label || 'Question', ctx) + (cq?.required ? ' *' : '');
    block.appendChild(title);

    const opts = parseOptionsLoose(cq?.options).map(cleanLabel);
    const saved = state.stateJSON.prep?.answers?.[key] ?? (cq?.saved != null ? cleanLabel(cq.saved) : null);

    opts.forEach(optRaw => {
      const rendered = interp(cleanLabel(optRaw), ctx);
      const id = `s2_${key}_${rendered.replace(/\W+/g,'_')}`;

      const row = document.createElement('div');
      row.className = 'cq-row';

      const rb = document.createElement('input');
      rb.type = 'radio';
      rb.name = `s2_${key}`;
      rb.id = id;
      rb.value = rendered;
      if (saved && String(saved) === rendered) rb.checked = true;

      rb.addEventListener('change', () => {
        ensureStateShape();
        state.stateJSON.prep.answers[key] = rendered;
        state.stateJSON.lastEditedAtISO = new Date().toISOString();
        prepDirty = true;
        markDirty();
      });

      const lab = document.createElement('label');
      lab.setAttribute('for', id);
      lab.textContent = rendered;

      row.append(rb, lab);
      block.appendChild(row);
    });

    mount.appendChild(block);
  });

  updateSaveUI();
}

function renderAgenda(){
  ensureStateShape();

  const container = document.createElement('div');
  container.className = 'agenda-wrap';
  container.style.marginTop = '16px';
  container.style.maxWidth = '660px';

  const title = document.createElement('div');
  title.className = 'agenda-title';
  title.textContent = 'Agenda: Add your questions to help shape the agenda below';
  container.appendChild(title);

  const list = document.createElement('div');
  list.id = 'agendaList';
  list.className = 'agenda-list';
  container.appendChild(list);

  const addRow = document.createElement('div');
  addRow.className = 'agenda-input-row';

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Add an agenda item‚Ä¶';

  const addBtn = document.createElement('button');
  addBtn.className = 'btn';
  addBtn.textContent = 'Add';

  addRow.append(input, addBtn);
  container.appendChild(addRow);

  const mount = document.getElementById('s2Questions');
  mount.appendChild(container);

  const editing = new Set();
  const items = () =>
    (state.stateJSON.agenda.items || []).slice().sort((a,b)=>(a.order??0)-(b.order??0));

  function paint(){
    list.innerHTML = '';
    const arr = items();

    // no ‚ÄúNo agenda items yet.‚Äù message; just show the input row above
    arr.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = 'sel-item';
      row.style.justifyContent = 'space-between';

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';
      left.style.gap = '8px';
      left.style.flex = '1 1 auto';

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '6px';
      actions.style.flexShrink = '0';

      const bullet = document.createElement('span');
      bullet.textContent = '‚Ä¢';
      left.appendChild(bullet);

      if (editing.has(it.id)){
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = it.text;
        inp.style.flex = '1 1 auto';
        left.appendChild(inp);

        const save = document.createElement('button');
        save.className = 'link-btn';
        save.textContent = 'Save';
        save.onclick = () => {
          const t = String(inp.value||'').trim();
          editing.delete(it.id);
          if (t && t !== it.text){
            it.text = t;
            agendaDirty = true;
            markDirty();
          }
          paint();
        };

        const cancel = document.createElement('button');
        cancel.className = 'link-btn';
        cancel.textContent = 'Cancel';
        cancel.onclick = () => { editing.delete(it.id); paint(); };

        const del = document.createElement('button');
        del.className = 'link-btn';
        del.textContent = 'Remove';
        del.onclick = () => {
          const src = state.stateJSON.agenda.items;
          const i = src.findIndex(x => x.id === it.id);
          if (i >= 0) src.splice(i,1);
          editing.delete(it.id);
          renumberOrders();
          agendaDirty = true;
          markDirty();
          paint();
        };

        actions.append(save, cancel, del);
      } else {
        const txt = document.createElement('div');
        txt.textContent = it.text;
        left.appendChild(txt);

        const edit = document.createElement('button');
        edit.className = 'link-btn';
        edit.textContent = 'Edit';
        edit.onclick = () => { editing.add(it.id); paint(); };

        const up = document.createElement('button');
        up.className = 'link-btn';
        up.textContent = '‚Üë';
        up.onclick = () => {
          const arr = items();
          if (idx === 0) return;
          const a = arr[idx], b = arr[idx-1];
          const tmp = a.order; a.order = b.order; b.order = tmp;
          renumberOrders();
          agendaDirty = true;
          markDirty();
          paint();
        };

        const down = document.createElement('button');
        down.className = 'link-btn';
        down.textContent = '‚Üì';
        down.onclick = () => {
          const arr = items();
          if (idx >= arr.length - 1) return;
          const a = arr[idx], b = arr[idx+1];
          const tmp = a.order; a.order = b.order; b.order = tmp;
          renumberOrders();
          agendaDirty = true;
          markDirty();
          paint();
        };

        if (idx === 0) {
          up.disabled = true;
          up.style.visibility = 'hidden';
        }
        if (idx === items().length - 1) {
          down.disabled = true;
          down.style.visibility = 'hidden';
        }

        const del = document.createElement('button');
        del.className = 'link-btn';
        del.textContent = 'Remove';
        del.onclick = () => {
          const src = state.stateJSON.agenda.items;
          const i = src.findIndex(x => x.id === it.id);
          if (i >= 0) src.splice(i,1);
          renumberOrders();
          agendaDirty = true;
          markDirty();
          paint();
        };

        actions.append(edit, up, down, del);
      }

      row.append(left, actions);
      list.appendChild(row);
    });
  }

  function nextOrder(){ return Math.max(0, ...state.stateJSON.agenda.items.map(x => Number(x.order||0))) + 1; }
  function renumberOrders(){
    state.stateJSON.agenda.items
      .sort((a,b)=>(a.order??0)-(b.order??0))
      .forEach((it, i) => it.order = i+1);
  }

  // Add new
  addBtn.onclick = () => {
    const text = String(input.value || '').trim();
    if (!text) return;
    input.value = '';
    const id = genId();
    state.stateJSON.agenda.items.push({ id, text, order: nextOrder() });
    agendaDirty = true;
    markDirty();
    paint();
  };
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){ e.preventDefault(); addBtn.click(); }
  });

  paint();
}

  async function fetchWeekAtGranularity(mondayKey, g) {
    const res = await apiGet('fetchWeek', { token, mondayKey, g });
    console.log('[fetchWeek raw]', res);
    // show an example of a slot with prep (if present)
    const withPrep = (res?.slots || []).find(s => s.prep);
    if (withPrep) console.log('[example prep]', withPrep.prep);
    const parsed = parseSlots(res && res.slots ? res.slots : []);
    console.log('[fetchWeek parsed first]', parsed[0]);
    return { parsed, count: parsed.length, g };
  }

  
  async function loadWeekCoarseToFine(mondayKey, { prefetch=false } = {}) {
    // UI cue (only when visible)
    if (!prefetch) showLoading('Scanning for availability‚Ä¶');
  
    // 60-min pass
    let all = await fetchWeekAtGranularity(mondayKey, 60);
    if (!prefetch && all.count < 3) { showLoading('Looking for prep slots‚Ä¶'); }
    // 30-min pass (only if needed)
    if (all.count < 3) {
      const next = await fetchWeekAtGranularity(mondayKey, 30);
      all = { parsed: [...all.parsed, ...next.parsed].sort((a,b)=>a.start-b.start), count: all.count + next.count };
    }
    // 15-min pass (only if still needed)
    if (all.count < 3) {
      if (!prefetch) showLoading('Taking a closer look‚Ä¶');
      const next = await fetchWeekAtGranularity(mondayKey, 15);
      all = { parsed: [...all.parsed, ...next.parsed].sort((a,b)=>a.start-b.start), count: all.count + next.count };
    }
  
    const payload = { slotsParsed: all.parsed, exactCount: all.count };
    state.weekCache.set(mondayKey, payload);
    return payload;
  }


  /**********************
   * Events & wiring
   **********************/
  tzSel.addEventListener('change', () => {
    state.tz = tzSel.value;
    if (!overviewView.classList.contains('hide')) {
      renderOverview();
    } else if (state.currentWeek && state.weekCache.has(state.currentWeek)) {
      renderWeek(state.weekCache.get(state.currentWeek));
    }
    // ‚¨áÔ∏è new: if inline section is visible, refresh it
    const inline = document.getElementById('landingInline');
    if (inline && inline.children.length) renderInlineQuarterList();
  });


  tabOverview.onclick = renderOverview;
  tabWeek.onclick = () => {
    if (!state.currentWeek) {
      const months = [...state.monthWeeks.keys()].sort();
      if (months.length) {
        const wk = state.monthWeeks.get(months[0])?.[0];
        if (wk) return openWeek(String(wk.startISO).slice(0,10));
      }
    }
    if (state.currentWeek) openWeek(state.currentWeek);
  };

  prevWeekBtn.onclick = () => {
    if (!state.currentWeek) return;
    const wk = plusDaysKey(state.currentWeek, -7);
    openWeek(wk);
  };
  nextWeekBtn.onclick = () => {
    if (!state.currentWeek) return;
    const wk = plusDaysKey(state.currentWeek, 7);
    openWeek(wk);
  };

  /**********************
   * TZ select populate
   **********************/
  function populateTzSelect(zones, initial) {
    tzSel.innerHTML = '';
    (zones || []).forEach(z => {
      const opt = document.createElement('option');
      opt.value = z; opt.textContent = z;
      if (z === initial) opt.selected = true;
      tzSel.appendChild(opt);
    });
    state.tz = initial || state.tz || 'UTC';
    tzSel.onchange = () => {
      state.tz = tzSel.value;
      if (state.currentWeek && state.weekCache.has(state.currentWeek)) {
        renderWeek(state.weekCache.get(state.currentWeek));
      }
    };
  }

  /**********************
   * Boot
   **********************/
  function init() {
    const t = token;
    if (!t) { alert('Missing token in URL (?token=...)'); return; }
  
    showLoading('Loading meeting details‚Ä¶');
  
    apiGet('getInviteMeta', { token: t })
      .then(meta => {
        if (!meta?.ok) throw new Error(meta?.error || 'Meta fetch failed');
  
        state.meta = meta;
        
        // Coerce/parse meta.stateJSON from the API
        let sj = meta.stateJSON;
        if (sj && typeof sj === 'string') {
          try { sj = JSON.parse(sj); } catch { sj = null; }
        }
        if (!sj || typeof sj !== 'object') {
          sj = { version: 1, lastEditedAtISO: new Date().toISOString(), prep: { answers: {} }, agenda: { items: [] } };
        }
        state.stateJSON = sj;
        
        console.log('stateJSON (parsed):', state.stateJSON);


  
        // Names in header/step 2/landing
        const displayName = meta.colleagueFirstName || meta.colleagueEmail || '';
        const meetingType = meta.meetingType || 'Book a session';
        const customerName = meta.customerName || meta.accountName || '';
        state.meta.customerName = customerName;                             
        
        // Notice/header name
        if (colleagueNameEl) colleagueNameEl.textContent = displayName;
        
        // Step 2 header name
        const s2ColleagueEl = document.getElementById('s2Colleague');
        if (s2ColleagueEl) s2ColleagueEl.textContent = displayName;
        
        // Landing title (two lines):
        // "<Customer Name> & Culture Amp"
        // "<Meeting Type> with <Colleague First Name>"
        const landingTitleEl = document.querySelector('#landingView .week-title');
        if (landingTitleEl) {
          landingTitleEl.innerHTML =
            `<div style="font-weight:800">${escapeHtml(customerName)} &amp; Culture Amp</div>
             <div>${escapeHtml(meetingType)} with <span id="landingColleague"></span></div>`;
          const landingColleagueEl = document.getElementById('landingColleague');
          if (landingColleagueEl) landingColleagueEl.textContent = displayName;
        }
  
        // Show LANDING immediately (instead of Overview)
        showOnly('landing');
        refreshLandingCards();

        if (typeof setBreadcrumbForLanding === 'function') setBreadcrumbForLanding();
  
        // Preload invitees
        if (Array.isArray(meta.suggestedInvitees)) {
          state.suggestedInvitees = meta.suggestedInvitees;
        }
        if (Array.isArray(meta.preselectedCustomerEmails)) {
          state.preselectedCustomerEmails = meta.preselectedCustomerEmails;
        }
  
        // Confirm questions (we‚Äôll use them in Step 2)
        if (meta.confirmQuestions || meta.confirmQuestionsJSON) {
          state.confirmQuestions = coerceCqs(meta.confirmQuestions || meta.confirmQuestionsJSON);
        }
        if (!state.confirmQuestions.length && meta.confirmQuestion) {
          state.confirmQuestions = [meta.confirmQuestion]; // legacy single-question support
        }
  
        if (meta.initialTz) initialTz = meta.initialTz;
        if (typeof meta.maxHolds === 'number') MAX_SELECT = meta.maxHolds;
  
        if (meta.status !== 'NEW' && !meta.allowRebook) {
          hideLoading();
          refreshLandingCards({ metaOverride: meta });
          showOnly('landing');
    
          // Make the app visible
          const app = document.getElementById('app');
          if (app) {
            app.removeAttribute('inert');
            app.removeAttribute('aria-hidden');
          }
          document.documentElement.classList.remove('booting');
    
          return; // <-- Gracefully stop here instead of throwing an error
        }

        // Build weeks locally instead of fetching
        const opts = {
          initialTz: meta.initialTz || initialTz || 'UTC',
          weeks: 24,
          minNoticeDays: Number(meta?.options?.minNoticeDays ?? 0),
          weekdaysCSV: String(meta?.options?.weekdaysCSV || 'Mon,Tue,Wed,Thu,Fri'),
          blackoutDatesCSV: String(meta?.options?.blackoutDatesCSV || '')
        };
    
        if (Array.isArray(meta.timezones)) timezones = meta.timezones;
        if (opts.initialTz) initialTz = opts.initialTz;
        populateTzSelect(timezones, initialTz);

        // After meta processed + local weeks built:
        hideLoading();
        const app = document.getElementById('app');
        if (app) {
          app.removeAttribute('inert');
          app.removeAttribute('aria-hidden');
        }
        document.documentElement.classList.remove('booting');

        if (typeof meta.maxHolds === 'number') MAX_SELECT = meta.maxHolds;
    
        if (Array.isArray(meta.suggestedInvitees)) state.suggestedInvitees = meta.suggestedInvitees;
        if (Array.isArray(meta.preselectedCustomerEmails)) state.preselectedCustomerEmails = meta.preselectedCustomerEmails;
    
        if (!state.confirmQuestions.length) {
          if (meta.confirmQuestions || meta.confirmQuestionsJSON) {
            state.confirmQuestions = coerceCqs(meta.confirmQuestions || meta.confirmQuestionsJSON);
          } else if (meta.confirmQuestion) {
            state.confirmQuestions = [meta.confirmQuestion];
          }
        }
    
        // Show the full *current* quarter (past weeks will be present but disabled)
        const localWeeks = generateWeeksForCurrentQuarter({
          initialTz: opts.initialTz || 'UTC',
          minNoticeDays: opts.minNoticeDays,
          weekdaysCSV:  opts.weekdaysCSV,
          blackoutDatesCSV: opts.blackoutDatesCSV
        });
        
        state.monthWeeks = buildMonthWeeksFromWeekList(localWeeks);

      })
      .catch(err => {
        if (String(err?.message) !== 'used_link') {
          alert((err && err.message) || 'Failed to initialize.');
        }
      });
  }

  function refreshLandingCards({ metaOverride } = {}) {
    const s1 = document.getElementById('step1Card');
    const s2 = document.getElementById('step2Card');
    if (!s1 || !s2) return;
  
    const meta = metaOverride || state.meta || {};
    const flow = computeFlow(meta);
  
    const tz = state.tz || meta.initialTz || 'UTC';
    const sel = getPrimarySelectedStart(meta); // Date | null
    const dur = Number(meta.durationMins || 30);
    const end = meta.bookedEndISO ? new Date(meta.bookedEndISO)
              : (sel ? new Date(sel.getTime() + dur*60000) : null);

  
    const whenDate = sel ? fmtDateLocal(sel, tz) : '';
    const whenTime = (sel && end) ? fmtRangeLocal(sel, end, tz) : '';
  
    const colleagueFirst = meta.colleagueFirstName || 'your People Scientist';
  
    if (flow === 'NEW') {
      setStepCard(s1, {
        state: 'active',
        title: 'Step 1',
        body: 'Pick a time that works for you.',
        onClick: () => showInlineOverview()
      });
      setStepCard(s2, {
        state: 'inactive',
        title: 'Step 2',
        body: `Share some details so ${colleagueFirst} can prepare.`
      });
      return;
    }
  
    if (flow === 'USED_FUTURE') {
      setStepCard(s1, {
        state: 'locked',
        title: '‚úÖ Booked',
        body: `${whenDate} ‚Ä¢ ${whenTime}`,
        showRebook: !!meta.allowRebook,
        extraClass: 'booked'
      });
      setStepCard(s2, {
        state: 'active',
        title: 'Step 2',
        body: `Share some details below, so ${colleagueFirst} can prepare.`,
        onClick: () => {
          // Open Step 2 using the booked slot context (synthesized if needed)
            const prepFromMeta =
            (state.meta?.bookedPrepStartISO && state.meta?.bookedPrepEndISO)
              ? { start: new Date(state.meta.bookedPrepStartISO),
                  end:   new Date(state.meta.bookedPrepEndISO) }
              : null;
          
          const slot = sel ? {
            start: sel,
            end: end,
            ...(prepFromMeta ? { prep: prepFromMeta } : {})
          } : null;

          if (slot) renderStep2FromSlot(slot);
          document.getElementById('step2')?.classList.remove('hide');
          document.getElementById('overviewView')?.classList.add('hide');
          document.getElementById('weekView')?.classList.add('hide');
        }
      });
      return;
    }
  
    // USED_PAST
    setStepCard(s1, {
      state: 'locked',
      title: 'Meeting date passed',
      body: `${whenDate} ‚Ä¢ ${whenTime}`,
      extraClass: 'booked'
    });
    setStepCard(s2, {
      state: 'inactive',
      title: 'Step 2',
      body: 'The meeting booked with this link is in the past'
    });
  }

  function interp(str, ctx={}) {
    if (str == null) return '';
    return String(str).replace(/\$\{(\w+)\}/g, (_, k) =>
      (ctx[k] !== undefined && ctx[k] !== null) ? String(ctx[k]) : ''
    );
  }

  function parseAllowedWeekdays(csv='Mon,Tue,Wed,Thu,Fri'){
    const map = {Sun:7, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6};
    return new Set(csv.split(',').map(s=>map[String(s).trim().slice(0,3)]).filter(Boolean));
  }
  function dayOfWeekFromKey(dayKey){ // Mon=1 ... Sun=7 (UTC)
    const js = new Date(dayKey + 'T00:00:00Z').getUTCDay(); // Sun=0..Sat=6
    return js === 0 ? 7 : js;
  }
  
  function generateWeeksLocally({
    initialTz = 'UTC',
    weeks = 24,
    minNoticeDays = 0,
    weekdaysCSV = 'Mon,Tue,Wed,Thu,Fri',
    blackoutDatesCSV = ''
  } = {}) {
    // Anchor from "this week's Monday" (in your UI you label by Monday starts)
    const today = todayKey(initialTz);            // 'YYYY-MM-DD' in user's tz
    const firstMonday = mondayKey(today);         // Monday key of the current week
    const minStartKey = plusDaysKey(today, minNoticeDays); // earliest bookable day (yyyy-mm-dd)
  
    const allowedWeekdays = parseAllowedWeekdays(weekdaysCSV);
    const blackouts = new Set(
      String(blackoutDatesCSV || '')
        .split(/[,\s]+/)
        .map(s => s.trim())
        .filter(s => /^\d{4}-\d{2}-\d{2}$/.test(s))
    );
  
    const out = [];
    for (let i = 0; i < weeks; i++) {
      const monKey = plusDaysKey(firstMonday, i * 7);
      const days = weekDaysFromMondayKey(monKey);
  
      // selectable if ANY allowed day in the week is on/after minStart and not blacked out
      const selectable = days.some(dayKey =>
        dayKey >= minStartKey &&
        !blackouts.has(dayKey) &&
        allowedWeekdays.has(dayOfWeekFromKey(dayKey))
      );
  
      out.push({
        startISO: new Date(monKey + 'T00:00:00Z').toISOString(),
        weekNum:  isoWeekNumberFromKey(monKey),
        selectable
      });
    }
    return out;
  }

  /* ===== Landing flow helpers ===== */
  function getPrimarySelectedStart(meta) {
    // Try selectedStartsJSON (array or JSON string), else bookedStartISO
    let arr = [];
    try {
      if (Array.isArray(meta.selectedStartsJSON)) arr = meta.selectedStartsJSON;
      else if (typeof meta.selectedStartsJSON === 'string' && meta.selectedStartsJSON.trim()) {
        arr = JSON.parse(meta.selectedStartsJSON);
      }
    } catch { /* ignore */ }
  
    const dates = (arr || []).map(s => new Date(s)).filter(d => !isNaN(+d));
    if (!dates.length && meta.bookedStartISO) {
      const d = new Date(meta.bookedStartISO);
      return isNaN(+d) ? null : d;
    }
    if (!dates.length) return null;
  
    const now = new Date();
    const future = dates.filter(d => d > now).sort((a,b)=>a-b);
    if (future.length) return future[0];          // earliest future
    return dates.sort((a,b)=>b-a)[0];             // latest past
  }
  
  function computeFlow(meta){
    const sel = getPrimarySelectedStart(meta);
    if (!sel) return 'NEW';
    return (sel > new Date()) ? 'USED_FUTURE' : 'USED_PAST';
  }
  
/**********************
 * Inline Quarter + Week (landing page, "See more" appends)
 **********************/

// helpers
function ymToDate(ym){ const [y,m]=ym.split('-').map(Number); return new Date(Date.UTC(y, m-1, 1)); }
function monthTitleFromYM(ym){ const [y,m]=ym.split('-').map(Number); return monthTitle(y,m); }
function qKeyOfYM(ym){
  const [y,m] = ym.split('-').map(Number);
  const q = Math.floor((m-1)/3)+1;
  return `${y}-Q${q}`;
}
function monthsInQuarter(y,q){
  const start = (q-1)*3+1;
  const pad = n => String(n).padStart(2,'0');
  return [`${y}-${pad(start)}`, `${y}-${pad(start+1)}`, `${y}-${pad(start+2)}`];
}
function parseQKey(qkey){ const [y, qpart] = qkey.split('-Q'); return { y: +y, q: +qpart }; }

// Build a continuous list of quarters spanning the data you have.
function buildQuarterListFull({ futureQuarters = 3, pastQuarters = 0 } = {}) {
  const keys = [...(state.monthWeeks?.keys() || [])].sort(); // ["YYYY-MM", ...]
  const now = new Date();
  const curY = now.getUTCFullYear();
  const curM = now.getUTCMonth() + 1;
  const curQ  = Math.floor((curM - 1) / 3) + 1;
  const curQKey = `${curY}-Q${curQ}`;

  // Helper utilities
  const ymToDate = (ym) => { const [y,m]=ym.split('-').map(Number); return new Date(Date.UTC(y, m-1, 1)); };
  const monthsInQuarter = (y,q) => {
    const s = (q-1)*3 + 1, pad = n => String(n).padStart(2,'0');
    return [`${y}-${pad(s)}`, `${y}-${pad(s+1)}`, `${y}-${pad(s+2)}`];
  };
  const toNextQuarter = (y,q) => (q===4) ? { y:y+1, q:1 } : { y, q:q+1 };
  const toPrevQuarter = (y,q) => (q===1) ? { y:y-1, q:4 } : { y, q:q-1 };

  // Determine natural bounds from existing weeks (may be just current quarter)
  let minYM = keys[0] || `${curY}-${String(curM).padStart(2,'0')}`;
  let maxYM = keys[keys.length-1] || minYM;

  // Ensure current quarter is within bounds
  const curYM = `${curY}-${String(curM).padStart(2,'0')}`;
  if (ymToDate(minYM) > ymToDate(curYM)) minYM = curYM;
  if (ymToDate(maxYM) < ymToDate(curYM)) maxYM = curYM;

  // Convert bounds to (y,q)
  const ymToYQ = (ym) => {
    const d = ymToDate(ym);
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth()+1;
    return { y, q: Math.floor((m-1)/3)+1 };
  };
  let { y: minY, q: minQ } = ymToYQ(minYM);
  let { y: maxY, q: maxQ } = ymToYQ(maxYM);

  // Expand by requested horizon
  for (let i = 0; i < pastQuarters; i++) ({ y:minY, q:minQ } = toPrevQuarter(minY, minQ));
  for (let i = 0; i < futureQuarters; i++) ({ y:maxY, q:maxQ } = toNextQuarter(maxY, maxQ));

  // Build list from min..max
  const list = [];
  let y = minY, q = minQ;
  while (true) {
    list.push({ key: `${y}-Q${q}`, label: `Q${q} ${y}`, months: monthsInQuarter(y, q) });
    if (y === maxY && q === maxQ) break;
    ({ y, q } = toNextQuarter(y, q));
  }

  // Ensure current quarter is present (it will be)
  if (!list.find(x => x.key === curQKey)) {
    list.push({ key: curQKey, label: `Q${curQ} ${curY}`, months: monthsInQuarter(curY, curQ) });
    list.sort((a,b) => a.key.localeCompare(b.key));
  }

  return list;
}


function findCurrentQuarterIndex(quarters){
  const now = new Date();
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth()+1;
  const q = Math.floor((m-1)/3)+1;
  const key = `${y}-Q${q}`;
  const i = quarters.findIndex(x => x.key === key);
  return i >= 0 ? i : 0;
}

// public entry from Step 1 / Rebook
function showInlineOverview(){
  const mount = document.getElementById('landingInline');
  if (!mount) return;

  // Use your existing config to decide how many future quarters to show
  const monthsAhead = Number(state.meta?.options?.monthsAhead ?? 12);
  const futureQuarters = Math.max(1, Math.ceil(monthsAhead / 3)); // e.g., 12 -> 4

  state._quarters = buildQuarterListFull({ futureQuarters, pastQuarters: 0 });
  state._qStartIndex = findCurrentQuarterIndex(state._quarters);
  state._qRenderedEnd = state._qStartIndex;   // start with current quarter only

  renderInlineQuarterList();                   // "See more" will now append the next quarter(s)
}

function renderInlineQuarterList(){
  closeConfirmModal(true);
  const mount = document.getElementById('landingInline');
  if (!mount) return;

  // Full re-render of all currently "expanded" quarters
  mount.innerHTML = '';

  const quarters = state._quarters || [];
  if (!quarters.length){
    mount.innerHTML = '<div class="notice">No weeks available.</div>';
    return;
  }

  const start = state._qStartIndex ?? 0;
  const end   = state._qRenderedEnd ?? start;

  for (let i = start; i <= end; i++){
    renderQuarterSection(quarters[i], mount);
  }

  // "See more" (append one more quarter)
  const moreWrap = document.createElement('div');
  moreWrap.className = 'inline-controls';
  const moreBtn = document.createElement('button');
  moreBtn.className = 'btn';
  moreBtn.textContent = (end < quarters.length-1) ? 'See more' : 'No more to show';
  moreBtn.disabled = end >= quarters.length-1;
  moreBtn.onclick = () => {
    const nextEnd = Math.min(end + 1, quarters.length - 1);
    // Generate weeks for each newly revealed quarter
    for (let i = end + 1; i <= nextEnd; i++) {
      const q = quarters[i];
      const { y, q: qn } = parseQKey(q.key);
      const opts = {
        initialTz: state.meta?.initialTz || state.tz || 'UTC',
        minNoticeDays: Number(state.meta?.options?.minNoticeDays ?? 0),
        weekdaysCSV: String(state.meta?.options?.weekdaysCSV || 'Mon,Tue,Wed,Thu,Fri'),
        blackoutDatesCSV: String(state.meta?.options?.blackoutDatesCSV || '')
      };
      const weeks = generateWeeksForQuarter({ year: y, quarter: qn, ...opts });
      // merge into state.monthWeeks
      const mw = buildMonthWeeksFromWeekList(weeks);
      for (const [ym, arr] of mw.entries()) {
        if (!state.monthWeeks.has(ym)) state.monthWeeks.set(ym, []);
        // append any weeks we don't already have
        const existing = state.monthWeeks.get(ym);
        const seen = new Set(existing.map(w => w.startISO));
        arr.forEach(w => { if (!seen.has(w.startISO)) existing.push(w); });
        existing.sort((a,b)=>a.startISO.localeCompare(b.startISO));
      }
    }
    state._qRenderedEnd = nextEnd;
    renderInlineQuarterList();
  };
  moreWrap.appendChild(moreBtn);
  mount.appendChild(moreWrap);
}

// Render one quarter section: title + 3 month cards in ov-grid
function renderQuarterSection(quarter, mount){
  const title = document.createElement('div');
  title.className = 'inline-title';
  title.textContent = quarter.label;
  mount.appendChild(title);

  const grid = document.createElement('div');
  grid.className = 'ov-grid';

  quarter.months.forEach(ym => {
    const weeks = state.monthWeeks.get(ym) || []; // may be empty
    const card = document.createElement('div'); card.className = 'mcard';

    const head = document.createElement('div'); head.className = 'mhead';
    const name = document.createElement('div'); name.className = 'mname'; name.textContent = monthTitleFromYM(ym);
    head.appendChild(name); card.appendChild(head);

    const list = document.createElement('div'); list.className = 'weeks';

    if (!weeks.length){
      const empty = document.createElement('div');
      empty.className = 'notice';
      empty.textContent = 'No weeks to show.';
      list.appendChild(empty);
    } else {
      weeks.forEach(w => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'week-pill';
        btn.textContent = `${formatWeekLabel(w.startISO)} ‚Äî Wk ${w.weekNum}`;

        const monKey = w.startISO.slice(0,10);
        if (!w.selectable) {
          btn.classList.add('disabled');
          btn.disabled = true;
        } else {
          btn.addEventListener('click', () => openWeekInline(monKey));
        }
        list.appendChild(btn);
      });
    }

    card.appendChild(list);
    grid.appendChild(card);
  });

  mount.appendChild(grid);
}

// Show a week inline (replaces the cards area); Back restores the list as expanded
function openWeekInline(mondayKey){
  state.currentWeek = mondayKey;
  const mount = document.getElementById('landingInline');
  if (!mount) return;

  mount.innerHTML = '';
  showLoading('Loading this week‚Ä¶');
  ensureWeekLoaded(mondayKey)
    .then(payload => {
      renderWeekInline(payload, mondayKey);
      prefetchNeighbors(mondayKey);
    })
    .catch(err => alert('Failed to load week.\n' + (err?.message || err)))
    .finally(hideLoading);
}

function renderWeekInline(payload, mondayKey){
  const mount = document.getElementById('landingInline');
  if (!mount) return;

  const wrap = document.createElement('div');
  wrap.className = 'week-wrap';

  const head = document.createElement('div');
  head.className = 'week-head';

  const back = document.createElement('button');
  back.className = 'nav-btn';
  back.textContent = '‚Üê Back to results';
  back.onclick = () => { 
  closeConfirmModal(true);   
  renderInlineQuarterList();
  };

  const title = document.createElement('div');
  title.className = 'week-title';
  const d = new Date(mondayKey + 'T00:00:00Z');
  title.textContent = `${d.toLocaleString('en-GB', { month: 'long', year: 'numeric' })} ‚Ä¢ Week ${isoWeekNumberFromKey(mondayKey)}`;

  const nextPrev = document.createElement('div');
  nextPrev.style.display = 'flex';
  nextPrev.style.gap = '8px';

  const prevBtn = document.createElement('button');
  prevBtn.className = 'nav-btn';
  prevBtn.textContent = '‚Üê';
  prevBtn.onclick = () => openWeekInline(plusDaysKey(mondayKey, -7));

  const nextBtn = document.createElement('button');
  nextBtn.className = 'nav-btn';
  nextBtn.textContent = '‚Üí';
  nextBtn.onclick = () => openWeekInline(plusDaysKey(mondayKey, 7));

  nextPrev.append(prevBtn, nextBtn);
  head.append(back, title, nextPrev);
  wrap.appendChild(head);

  // grid (same logic as your renderWeek)
  const grid = document.createElement('div');
  grid.className = 'grid';
  const gh = document.createElement('div');
  gh.className = 'grid-header';
  gh.innerHTML = '<div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>';
  grid.appendChild(gh);

  const daysEl = document.createElement('div');
  daysEl.className = 'days';

  const days = weekDaysFromMondayKey(mondayKey);
  const today = todayKey(state.tz);
  const byDay = new Map(days.map(k => [k, []]));

  (payload.slotsParsed || []).forEach(s => {
    const key = ymdKey(s.start, state.tz);
    if (byDay.has(key)) byDay.get(key).push(s);
  });
  days.forEach(k => byDay.get(k).sort((a,b)=>a.start-b.start));

  days.forEach(dayKey => {
    const inPast = dayKey < today;
    const dNum = Number(dayKey.slice(-2));
    const col = document.createElement('div');
    col.className = 'day' + (inPast ? ' past' : '');

    const header = document.createElement('div');
    header.className = 'day-header';
    const dateEl = document.createElement('div');
    dateEl.className = 'date';
    dateEl.textContent = dNum;
    header.appendChild(dateEl);
    col.appendChild(header);

    const body = document.createElement('div');
    body.className = 'day-body';

    const items = byDay.get(dayKey) || [];
    items.forEach(slot => {
      const iso = slot.start.toISOString();
      const pill = document.createElement('button');
      pill.type = 'button';
      pill.className = 'pill';

      const icon = document.createElement('span'); icon.className = 'icon'; icon.textContent = '‚óã';
      const label = document.createElement('span'); label.className = 'label';
      label.textContent = `${tzTimeHM(slot.start, state.tz)} ‚Äì ${tzTimeHM(slot.end, state.tz)}`;
      pill.append(icon, label);

      pill.onclick = () => {
        // single-select: clear any other selected pill
        document.querySelectorAll('.pill.selected').forEach(el => {
          if (el !== pill) {
            el.classList.remove('selected');
            const ic = el.querySelector('.icon'); if (ic) ic.textContent = '‚óã';
          }
        });
      
        pill.classList.add('selected'); icon.textContent = '‚úì';
        pendingIso = iso;        
        pendingPill = pill;             
        openConfirmModal(iso, slot);
      };
      
      body.appendChild(pill);
    });

    col.appendChild(body);
    daysEl.appendChild(col);
  });

  grid.appendChild(daysEl);
  wrap.appendChild(grid);

  const meta = document.createElement('div');
  meta.className = 'notice';
  meta.textContent = `Found ${payload.exactCount || 0} slot${(payload.exactCount || 0) === 1 ? '' : 's'}.`;
  wrap.appendChild(meta);

  mount.innerHTML = '';
  mount.appendChild(wrap);
}


  function setStepCard(el, {state, title, body, onClick, showRebook, extraClass}) {
    el.classList.remove('active','locked','inactive','booked');
    el.classList.add(state);
    if (extraClass) el.classList.add(extraClass);
  
    el.innerHTML = `
      <h3>${escapeHtml(title)}</h3>
      <p>${escapeHtml(body)}</p>
      ${showRebook ? `<div class="step-subtle" id="rebookLink">Rebook</div>` : '' }
    `;
  
    el.onclick = null;
    if (state === 'active' && typeof onClick === 'function') {
      el.onclick = onClick;
    } else if (showRebook) {
      el.querySelector('#rebookLink')?.addEventListener('click', (e) => {
        e.stopPropagation();
        showInlineOverview();          // ‚Üê was goToOverview()
      });
    }
  }

function runBlocking(promiseFactory, {
  startMsg = "Working‚Ä¶",
  slowMsg  = "Still working‚Ä¶ calendars can be slow.",
  slowAfterMs = 1200,
  preShown = false            // if true, we assume the modal is already visible
} = {}) {
  if (preShown) {
    loadingMsg.textContent = startMsg;
  } else {
    showLoading(startMsg);
  }

  // ensure the ‚ÄústartMsg‚Äù frame actually renders before doing work
  return nextFrame().then(() => {
    let slowTimer = setTimeout(() => { loadingMsg.textContent = slowMsg; }, slowAfterMs);
    const clear = () => { clearTimeout(slowTimer); hideLoading(); };

    return Promise.resolve()
      .then(() => promiseFactory())
      .then(v  => { clear(); return v; })
      .catch(e => { clear(); throw e; });
  });
}

function generateWeeksForQuarter({
  year, quarter,
  initialTz = 'UTC',
  minNoticeDays = 0,
  weekdaysCSV = 'Mon,Tue,Wed,Thu,Fri',
  blackoutDatesCSV = ''
} = {}) {
  const pad = n => String(n).padStart(2,'0');
  const startMonth = (quarter - 1) * 3 + 1;              // 1,4,7,10
  const startKey   = `${year}-${pad(startMonth)}-01`;    // YYYY-MM-01
  const afterKey   = (startMonth === 10)
    ? `${year + 1}-01-01`
    : `${year}-${pad(startMonth + 3)}-01`;

  const startMon = mondayKey(startKey);
  const afterMon = mondayKey(afterKey);

  const allowedWeekdays = parseAllowedWeekdays(weekdaysCSV);
  const blackouts = new Set(
    String(blackoutDatesCSV||'')
      .split(/[,\s]+/)
      .map(s => s.trim())
      .filter(s => /^\d{4}-\d{2}-\d{2}$/.test(s))
  );
  const today = todayKey(initialTz);
  const minStartKey = plusDaysKey(today, minNoticeDays);

  const out = [];
  for (let wk = startMon; wk < afterMon; wk = plusDaysKey(wk, 7)) {
    const days = weekDaysFromMondayKey(wk);
    const selectable = days.some(d =>
      d >= minStartKey &&
      !blackouts.has(d) &&
      allowedWeekdays.has(dayOfWeekFromKey(d))
    );
    out.push({
      startISO: new Date(wk + 'T00:00:00Z').toISOString(),
      weekNum:  isoWeekNumberFromKey(wk),
      selectable
    });
  }
  return out;
}

function saveStatePatch(patch) {
  return apiPost('saveStatePatch', { token }, patch).then(res => {
    if (res && res.stateJSON) state.stateJSON = res.stateJSON; // server returns merged state
    return res;
  });
}

// Give the browser a frame (or two) to paint UI changes
const nextFrame = () => new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

// ---- IDs, dirty flag, and snapshot saving ----
function genId(){ return 'id_' + Math.random().toString(36).slice(2, 9); }

function ensureStateShape(){
  if (!state.stateJSON) state.stateJSON = { version:1, lastEditedAtISO:new Date().toISOString(), prep:{answers:{}}, agenda:{items:[]} };
  if (!state.stateJSON.prep) state.stateJSON.prep = { answers:{} };
  if (!state.stateJSON.agenda) state.stateJSON.agenda = { items:[] };
  if (!Array.isArray(state.stateJSON.agenda.items)) state.stateJSON.agenda.items = [];
}

async function saveSnapshot(){
  ensureStateShape();
  const btn = document.getElementById('s2SaveBtn');
  if (btn){ btn.textContent = 'Saving‚Ä¶'; btn.disabled = true; }

  try{
    state.stateJSON.lastEditedAtISO = new Date().toISOString();
    await apiPost('saveStateJSON', { token }, { stateJSON: state.stateJSON });
    markClean();                         // will hide the button + update timestamp
  } catch(e){
    console.warn('saveStateJSON failed', e);
    if (btn){ btn.textContent = 'Save recent changes üíæ'; btn.disabled = false; }
    alert('Could not save right now. Your changes are still visible locally.');
    updateSaveUI();
  } finally {
    if (btn){ btn.textContent = 'Save recent changes üíæ'; btn.disabled = false; }
  }
}

// optional autosave (keep or remove)
const saveSnapshotDebounced = makeDebounce(() => saveSnapshot().catch(()=>{}), 800);

// ---- unified dirty tracking ----
let agendaDirty = false;
let prepDirty   = false;

function markDirty(){
  updateSaveUI();
}

function markClean(){
  agendaDirty = false;
  prepDirty   = false;
  updateSaveUI();   // hides the Save button + updates "Last saved..."
}

function missingRequiredCount(){
  const qs = Array.isArray(state.confirmQuestions) && state.confirmQuestions.length
    ? state.confirmQuestions
    : (state.confirmQuestion ? [state.confirmQuestion] : []);
  if (!qs.length) return 0;
  const answers = state.stateJSON?.prep?.answers || {};
  let missing = 0;
  qs.forEach((q, idx) => {
    if (!q?.required) return;
    const key = String(q.key || ('q' + idx));
    if (!answers[key]) missing++;
  });
  return missing;
}

function updateSaveUI(){
  const btn  = document.getElementById('s2SaveBtn');
  const last = document.getElementById('s2LastSaved');
  const hint = document.getElementById('s2ReqHint');

  const isDirty = (agendaDirty || prepDirty);

  // Button only shows when there are unsaved edits
  if (btn) btn.style.display = isDirty ? '' : 'none';

  // Status text: either "Unsaved changes" or the last saved timestamp
  if (last) {
    last.textContent = isDirty
      ? 'Unsaved changes'
      : fmtLastSaved(state.stateJSON?.lastEditedAtISO, state.tz);
  }

  // Keep your required-questions count (purely informational now)
  updatePrepBannerHintOnly();
}


function fmtLastSaved(iso, tz){
  if (!iso) return 'Not saved yet';
  const d = new Date(iso);
  if (isNaN(+d)) return 'Not saved yet';
  const date = new Intl.DateTimeFormat('en-US', { timeZone: tz, month:'short', day:'2-digit', year:'numeric' }).format(d);
  const time = new Intl.DateTimeFormat('en-GB', { timeZone: tz, hour:'2-digit', minute:'2-digit', hour12:false }).format(d);
  return `Last saved on ${date} at ${time}`;
}

function buildRequiredHintText(){
  const m = missingRequiredCount();
  if (m <= 0) return '';
  return `(${m === 1 ? '1 required question is unanswered.' : `${m} required questions are unanswered.`})`;
}

function renderPrepBanner(slot){
  const s2Sub = document.getElementById('s2Sub');
  if (!s2Sub) return;

  const hasQs   = Array.isArray(state.confirmQuestions) && state.confirmQuestions.length > 0;
  const hasPrep = !!(slot && slot.prep && slot.prep.start && slot.prep.end);
  const colleagueName =
    state?.meta?.colleagueFirstName ||
    state?.meta?.colleagueEmail ||
    'your People Scientist';

  s2Sub.classList.add('prep-card');
  s2Sub.style.display = hasQs ? '' : 'none';

  // Top line
  let top;
  if (hasPrep){
    const ps = slot.prep.start;
    const startTime = fmtTimeLocal(ps, state.tz).replace(':','h');
    top = `We've held a preparation slot for ${colleagueName} on ${fmtDateLocal(ps, state.tz)} at ${startTime}. ` +
          `Answering the questions below will help them in their preparation.`;
  } else {
    top = `Answering the questions below will help them in their preparation.`;
  }

  const hint = buildRequiredHintText();
  s2Sub.innerHTML = `
    <div class="prep-banner"><strong>${top}</strong></div>
    ${hint ? `<div class="prep-hint">${hint}</div>` : ''}
    <div id="s2QMount"></div>
  `;
}

function updatePrepBannerHintOnly(){
  const s2Sub = document.getElementById('s2Sub');
  if (!s2Sub || s2Sub.style.display === 'none') return;
  const hint = buildRequiredHintText();
  let hintEl = s2Sub.querySelector('.prep-hint');
  if (hint && !hintEl){
    hintEl = document.createElement('div');
    hintEl.className = 'prep-hint';
    hintEl.textContent = hint;
    s2Sub.appendChild(hintEl);
  } else if (hintEl){
    if (hint) { hintEl.textContent = hint; hintEl.style.display=''; }
    else { hintEl.remove(); }
  }
}

  // Kick things off:
  init();
</script>

</body>
</html>
